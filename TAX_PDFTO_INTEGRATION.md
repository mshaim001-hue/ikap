# Интеграция taxpdfto с ikap

## Обзор

Проект `taxpdfto` теперь интегрирован с `ikap` для автоматического анализа налоговых деклараций. Агент работает прямо в `taxpdfto` на Render.com, а `ikap` получает готовый анализ.

## Настройка

### 1. Настройка taxpdfto на Render.com

1. Разверните проект `taxpdfto` на Render.com
2. Установите переменную окружения:
   - `OPENAI_API_KEY` - API ключ OpenAI для работы агента

3. Опционально:
   - `TAX_ANALYSIS_MODEL` - модель для анализа (по умолчанию `gpt-4o`)

### 2. Настройка ikap

1. Установите переменную окружения:
   - `TAX_PDF_SERVICE_URL` - URL сервиса taxpdfto на Render.com
   - **Текущий URL**: `https://ikap3-backend-latest.onrender.com`
   
   ⚠️ **Важно**: URL уже настроен в `render.yaml`, но убедитесь, что он совпадает с вашим развернутым сервисом.

## Как это работает

1. Пользователь загружает налоговые PDF файлы в ikap
2. ikap отправляет PDF файлы в taxpdfto с параметром `analyze=true`
3. taxpdfto:
   - Парсит PDF в текст
   - Запускает агента для анализа налоговых деклараций
   - Возвращает готовый анализ
4. ikap получает готовый анализ и сохраняет его в заявке
5. Анализ отображается под кнопкой "Аналитика по налогам" в заявке

## Формат ответа от taxpdfto

При `POST /process?analyze=true` сервис сохраняет анализ у себя в БД и возвращает:

```json
{
  "session_id": "uuid-анализа",
  "status": "completed",
  "analysis_text": "Аналитика (ИИ) с таблицей в Markdown — разместите у себя в результатах",
  "files_count": 2,
  "files": [
    {
      "filename": "100.00-2023.pdf",
      "text": "распарсенный текст...",
      "analysis": "тот же текст analysis_text (Аналитика ИИ с таблицей)"
    }
  ],
  "errors": []
}
```

- **session_id** — можно сохранить для последующего запроса `GET /api/analysis/<session_id>`.
- **analysis_text** — готовый блок «Аналитика (ИИ)» с таблицей; стороннее приложение сохраняет его у себя и выводит в результатах.
- В каждом элементе **files** поле **analysis** дублирует **analysis_text** (один общий анализ по всем декларациям).

## Fallback

Если `TAX_PDF_SERVICE_URL` не настроен или анализ не получен от taxpdfto, ikap использует старую логику с локальным агентом.

## API Endpoint

`POST /process?analyze=true`

Принимает:
- `files` или `file` - PDF файлы

Возвращает:
- `files` - массив с результатами парсинга и анализа
