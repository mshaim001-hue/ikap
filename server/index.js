const express = require('express')
const cors = require('cors')
const multer = require('multer')
const OpenAI = require('openai')
require('dotenv').config()

// ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° multer Ð´Ð»Ñ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ñ„Ð°Ð¹Ð»Ð¾Ð²
const upload = multer({ 
  storage: multer.memoryStorage(),
  limits: { fileSize: 10 * 1024 * 1024 } // 10MB Ð»Ð¸Ð¼Ð¸Ñ‚
})

console.log('Loading Agents SDK...')
const { codeInterpreterTool, Agent, Runner } = require('@openai/agents')
const { z } = require('zod')
console.log('Agents SDK loaded successfully')

const app = express()
app.use(cors())
app.use(express.json({ limit: '10mb' }))

// Ð¥Ñ€Ð°Ð½Ð¸Ð»Ð¸Ñ‰Ðµ Ð´Ð»Ñ Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ð¸ Ð´Ð¸Ð°Ð»Ð¾Ð³Ð¾Ð² (Ð² Ð¿Ð°Ð¼ÑÑ‚Ð¸)
// Ð’ Ð¿Ñ€Ð¾Ð´Ð°ÐºÑˆÐµÐ½Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ Redis Ð¸Ð»Ð¸ Ð±Ð°Ð·Ñƒ Ð´Ð°Ð½Ð½Ñ‹Ñ…
const conversationHistory = new Map()

// Ð¥Ñ€Ð°Ð½Ð¸Ð»Ð¸Ñ‰Ðµ Ð´Ð»Ñ Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð¿Ð¾ ÑÐµÑÑÐ¸ÑÐ¼
const sessionFiles = new Map()

// Ð¥Ñ€Ð°Ð½Ð¸Ð»Ð¸Ñ‰Ðµ Ð´Ð»Ñ Ñ„Ð¸Ð½Ð°Ð½ÑÐ¾Ð²Ñ‹Ñ… Ð¾Ñ‚Ñ‡ÐµÑ‚Ð¾Ð²
const sessionReports = new Map()

// Code Interpreter Ð±ÐµÐ· Ð¿Ñ€ÐµÐ´ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ‹Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð²
// Ð¤Ð°Ð¹Ð»Ñ‹ Ð±ÑƒÐ´ÑƒÑ‚ Ð´Ð¾Ð±Ð°Ð²Ð»ÑÑ‚ÑŒÑÑ Ð´Ð¸Ð½Ð°Ð¼Ð¸Ñ‡ÐµÑÐºÐ¸
const codeInterpreter = codeInterpreterTool({
  container: { type: 'auto' }
})

const ClassificationAgentSchema = z.object({
  classification: z.enum(['investment_registration', 'get_information', 'other'])
})

const classificationAgent = new Agent({
  name: 'Classification Agent',
  instructions: `ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»Ð¸ Ð½Ð°Ð¼ÐµÑ€ÐµÐ½Ð¸Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ:

- investment_registration: ÐµÑÐ»Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ñ…Ð¾Ñ‡ÐµÑ‚ Ð¿Ñ€Ð¸Ð²Ð»ÐµÑ‡ÑŒ Ð¸Ð½Ð²ÐµÑÑ‚Ð¸Ñ†Ð¸Ð¸, Ð·Ð°Ð¹Ð¼, Ð¾Ð±Ð»Ð¸Ð³Ð°Ñ†Ð¸Ð¸, Ð´Ð¾Ð»ÑŽ Ð±Ð¸Ð·Ð½ÐµÑÐ°, Ð¸Ð»Ð¸ Ð¾Ñ‚Ð²ÐµÑ‡Ð°ÐµÑ‚ Ð½Ð° Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹ Ð¾ Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ð¸. Ð’ÐÐ–ÐÐž: Ð»ÑŽÐ±Ñ‹Ðµ Ñ‡Ð¸ÑÐ»Ð°, ÑÑƒÐ¼Ð¼Ñ‹, Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ñ ÐºÐ¾Ð¼Ð¿Ð°Ð½Ð¸Ð¹, Ñ€ÐµÐºÐ²Ð¸Ð·Ð¸Ñ‚Ñ‹, Ð‘Ð˜Ð, email, Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½, Ñ„Ð°Ð¹Ð»Ñ‹, "Ð´Ð°", "Ð½ÐµÑ‚", ÐºÑ€Ð°Ñ‚ÐºÐ¸Ðµ Ð¾Ñ‚Ð²ÐµÑ‚Ñ‹ - ÑÑ‚Ð¾ Ñ‚Ð¾Ð¶Ðµ investment_registration!
- get_information: Ð¢ÐžÐ›Ð¬ÐšÐž ÐµÑÐ»Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ ÑÐ²Ð½Ð¾ ÑÐ¿Ñ€Ð°ÑˆÐ¸Ð²Ð°ÐµÑ‚ "ÐºÐ°Ðº?", "Ñ‡Ñ‚Ð¾ Ñ‚Ð°ÐºÐ¾Ðµ?", "Ñ€Ð°ÑÑÐºÐ°Ð¶Ð¸Ñ‚Ðµ Ð¾..." Ð˜ ÐÐ• Ð½Ð°Ñ…Ð¾Ð´Ð¸Ñ‚ÑÑ Ð² Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐµ Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ð¸
- other: Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÐµÑÐ»Ð¸ Ð·Ð°Ð¿Ñ€Ð¾Ñ ÑÐ¾Ð²ÐµÑ€ÑˆÐµÐ½Ð½Ð¾ Ð½Ðµ ÑÐ²ÑÐ·Ð°Ð½ Ñ Ð¸Ð½Ð²ÐµÑÑ‚Ð¸Ñ†Ð¸ÑÐ¼Ð¸ (Ð¿Ð¾Ð³Ð¾Ð´Ð°, ÑÐ¿Ð¾Ñ€Ñ‚, Ð¸ Ñ‚.Ð´.)

ÐŸÐ ÐÐ’Ð˜Ð›Ðž: Ð•ÑÐ»Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð² Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐµ Ð´Ð¸Ð°Ð»Ð¾Ð³Ð° (Ð¾Ñ‚Ð²ÐµÑ‡Ð°ÐµÑ‚ Ð½Ð° Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹, Ð¿Ñ€Ð¸ÐºÑ€ÐµÐ¿Ð»ÑÐµÑ‚ Ñ„Ð°Ð¹Ð»Ñ‹) - Ð’Ð¡Ð•Ð“Ð”Ð Ð²Ñ‹Ð±Ð¸Ñ€Ð°Ð¹ investment_registration!`,
  model: 'gpt-4o',
  outputType: ClassificationAgentSchema,
  modelSettings: { store: true }
})

const InvestmentAgentSchema = z.object({
  amount: z.number().nullable().optional(),
  term_months: z.number().nullable().optional(),
  completed: z.boolean().nullable().optional()
})

// Financial Analyst Agent Ð´Ð»Ñ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð°
const financialAnalystAgent = new Agent({
  name: 'Financial Analyst',
  instructions: `Ð¢Ñ‹ Ñ„Ð¸Ð½Ð°Ð½ÑÐ¾Ð²Ñ‹Ð¹ Ð°Ð½Ð°Ð»Ð¸Ñ‚Ð¸Ðº iKapitalist. Ð¢Ð²Ð¾Ñ Ð·Ð°Ð´Ð°Ñ‡Ð° - ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ ÐŸÐžÐ”Ð ÐžÐ‘ÐÐ«Ð™ Ñ„Ð¸Ð½Ð°Ð½ÑÐ¾Ð²Ñ‹Ð¹ Ð¾Ñ‚Ñ‡ÐµÑ‚ Ð´Ð»Ñ Ð¼ÐµÐ½ÐµÐ´Ð¶ÐµÑ€Ð° Ð½Ð° Ð¾ÑÐ½Ð¾Ð²Ðµ Ð¿Ñ€ÐµÐ´Ð¾ÑÑ‚Ð°Ð²Ð»ÐµÐ½Ð½Ñ‹Ñ… Ð±Ð°Ð½ÐºÐ¾Ð²ÑÐºÐ¸Ñ… Ð²Ñ‹Ð¿Ð¸ÑÐ¾Ðº.

Ð¡Ð¢Ð Ð£ÐšÐ¢Ð£Ð Ð ÐžÐ¢Ð§Ð•Ð¢Ð:

ðŸ“Š **Ð Ð•Ð—Ð®ÐœÐ• Ð—ÐÐ¯Ð’ÐšÐ˜**
- ÐšÐ¾Ð¼Ð¿Ð°Ð½Ð¸Ñ: [Ð‘Ð˜Ð]
- Ð—Ð°Ð¿Ñ€Ð°ÑˆÐ¸Ð²Ð°ÐµÐ¼Ð°Ñ ÑÑƒÐ¼Ð¼Ð°: [ÑÑƒÐ¼Ð¼Ð°] KZT
- Ð¡Ñ€Ð¾Ðº: [Ð¼ÐµÑÑÑ†ÐµÐ²]
- Ð¦ÐµÐ»ÑŒ: [Ñ†ÐµÐ»ÑŒ Ñ„Ð¸Ð½Ð°Ð½ÑÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ]
- ÐšÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ñ‹: [Ð¸Ð¼Ñ, Ñ„Ð°Ð¼Ð¸Ð»Ð¸Ñ, email, Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½]

ðŸ’° **Ð¤Ð˜ÐÐÐÐ¡ÐžÐ’Ð«Ð™ ÐÐÐÐ›Ð˜Ð— ÐŸÐž Ð‘ÐÐÐšÐÐœ**

Ð”Ð»Ñ ÐšÐÐ–Ð”ÐžÐ“Ðž Ð±Ð°Ð½ÐºÐ° Ð¿Ñ€ÐµÐ´Ð¾ÑÑ‚Ð°Ð²ÑŒ:

1. **ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ Ð±Ð°Ð½ÐºÐ°** (Ð¸Ð·Ð²Ð»ÐµÐºÐ¸ Ð¸Ð· Ð²Ñ‹Ð¿Ð¸ÑÐºÐ¸)
2. **ÐŸÐµÑ€Ð¸Ð¾Ð´ Ð²Ñ‹Ð¿Ð¸ÑÐºÐ¸**: Ñ [Ð´Ð°Ñ‚Ð°] Ð¿Ð¾ [Ð´Ð°Ñ‚Ð°]
3. **ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð¼ÐµÑÑÑ†ÐµÐ²**: [X Ð¼ÐµÑÑÑ†ÐµÐ²]

**ÐžÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ Ð¿Ð¾ÐºÐ°Ð·Ð°Ñ‚ÐµÐ»Ð¸ Ð·Ð° Ð¿ÐµÑ€Ð¸Ð¾Ð´:**
- Ð’Ñ…Ð¾Ð´ÑÑ‰Ð¸Ð¹ Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ðº: [ÑÑƒÐ¼Ð¼Ð°] KZT
- Ð˜ÑÑ…Ð¾Ð´ÑÑ‰Ð¸Ð¹ Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ðº: [ÑÑƒÐ¼Ð¼Ð°] KZT
- ÐžÐ±Ñ‰Ð¸Ð¹ Ð¾Ð±Ð¾Ñ€Ð¾Ñ‚: [ÑÑƒÐ¼Ð¼Ð°] KZT
- ÐŸÑ€Ð¸Ñ…Ð¾Ð´ (ÐºÑ€ÐµÐ´Ð¸Ñ‚): [ÑÑƒÐ¼Ð¼Ð°] KZT
- Ð Ð°ÑÑ…Ð¾Ð´ (Ð´ÐµÐ±ÐµÑ‚): [ÑÑƒÐ¼Ð¼Ð°] KZT
- Ð¡Ñ€ÐµÐ´Ð½Ð¸Ð¹ Ð¼ÐµÑÑÑ‡Ð½Ñ‹Ð¹ Ð¾Ð±Ð¾Ñ€Ð¾Ñ‚: [ÑÑƒÐ¼Ð¼Ð°] KZT
- Ð¡Ñ€ÐµÐ´Ð½Ð¸Ð¹ Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ðº Ð½Ð° ÑÑ‡ÐµÑ‚Ðµ: [ÑÑƒÐ¼Ð¼Ð°] KZT

**Ð”ÐµÑ‚Ð°Ð»ÑŒÐ½Ð°Ñ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ°:**
- ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¹: [Ñ‡Ð¸ÑÐ»Ð¾]
- Ð¡Ñ€ÐµÐ´Ð½ÑÑ ÑÑƒÐ¼Ð¼Ð° Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¸: [ÑÑƒÐ¼Ð¼Ð°] KZT
- ÐœÐ°ÐºÑÐ¸Ð¼Ð°Ð»ÑŒÐ½Ð°Ñ Ñ‚Ñ€Ð°Ð½Ð·Ð°ÐºÑ†Ð¸Ñ (Ð¿Ñ€Ð¸Ñ…Ð¾Ð´): [ÑÑƒÐ¼Ð¼Ð°] KZT
- ÐœÐ°ÐºÑÐ¸Ð¼Ð°Ð»ÑŒÐ½Ð°Ñ Ñ‚Ñ€Ð°Ð½Ð·Ð°ÐºÑ†Ð¸Ñ (Ñ€Ð°ÑÑ…Ð¾Ð´): [ÑÑƒÐ¼Ð¼Ð°] KZT

**Ð”Ð¸Ð½Ð°Ð¼Ð¸ÐºÐ° Ð¿Ð¾ Ð¼ÐµÑÑÑ†Ð°Ð¼:**
[Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° Ð¸Ð»Ð¸ ÑÐ¿Ð¸ÑÐ¾Ðº Ð¿Ð¾ ÐºÐ°Ð¶Ð´Ð¾Ð¼Ñƒ Ð¼ÐµÑÑÑ†Ñƒ Ñ Ð¾Ð±Ð¾Ñ€Ð¾Ñ‚Ð¾Ð¼ Ð¸ Ð¾ÑÑ‚Ð°Ñ‚ÐºÐ¾Ð¼]

ðŸ“ˆ **Ð¡Ð’ÐžÐ”ÐÐÐ¯ ÐÐÐÐ›Ð˜Ð¢Ð˜ÐšÐ ÐŸÐž Ð’Ð¡Ð•Ðœ Ð‘ÐÐÐšÐÐœ**

- ÐžÐ±Ñ‰Ð¸Ð¹ Ð¾Ð±Ð¾Ñ€Ð¾Ñ‚ Ð¿Ð¾ Ð²ÑÐµÐ¼ ÑÑ‡ÐµÑ‚Ð°Ð¼: [ÑÑƒÐ¼Ð¼Ð°] KZT
- ÐžÐ±Ñ‰Ð¸Ð¹ ÑÑ€ÐµÐ´Ð½Ð¸Ð¹ Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ðº: [ÑÑƒÐ¼Ð¼Ð°] KZT
- ÐžÐ±Ñ‰ÐµÐµ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¹: [Ñ‡Ð¸ÑÐ»Ð¾]
- Ð¡Ñ€ÐµÐ´Ð½Ð¸Ð¹ Ð¼ÐµÑÑÑ‡Ð½Ñ‹Ð¹ Ð¾Ð±Ð¾Ñ€Ð¾Ñ‚ (Ð²ÑÐµ Ð±Ð°Ð½ÐºÐ¸): [ÑÑƒÐ¼Ð¼Ð°] KZT

ðŸŽ¯ **ÐžÐ¦Ð•ÐÐšÐ Ð¤Ð˜ÐÐÐÐ¡ÐžÐ’ÐžÐ™ Ð£Ð¡Ð¢ÐžÐ™Ð§Ð˜Ð’ÐžÐ¡Ð¢Ð˜**

ÐŸÑ€Ð¾Ð°Ð½Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐ¹:
1. **Ð¡Ñ‚Ð°Ð±Ð¸Ð»ÑŒÐ½Ð¾ÑÑ‚ÑŒ Ð¿Ð¾ÑÑ‚ÑƒÐ¿Ð»ÐµÐ½Ð¸Ð¹**: Ñ€ÐµÐ³ÑƒÐ»ÑÑ€Ð½Ñ‹Ðµ Ð¸Ð»Ð¸ Ð½ÐµÑ€ÐµÐ³ÑƒÐ»ÑÑ€Ð½Ñ‹Ðµ Ð¿Ð¾ÑÑ‚ÑƒÐ¿Ð»ÐµÐ½Ð¸Ñ
2. **Ð›Ð¸ÐºÐ²Ð¸Ð´Ð½Ð¾ÑÑ‚ÑŒ**: Ð´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ Ð»Ð¸ ÑÑ€ÐµÐ´ÑÑ‚Ð² Ð½Ð° ÑÑ‡ÐµÑ‚Ð°Ñ…
3. **Ð¢Ñ€ÐµÐ½Ð´**: Ñ€Ð°ÑÑ‚ÑƒÑ‰Ð¸Ðµ, ÑÑ‚Ð°Ð±Ð¸Ð»ÑŒÐ½Ñ‹Ðµ Ð¸Ð»Ð¸ Ð¿Ð°Ð´Ð°ÑŽÑ‰Ð¸Ðµ Ð¾Ð±Ð¾Ñ€Ð¾Ñ‚Ñ‹
4. **Ð Ð¸ÑÐºÐ¸**: Ð²Ñ‹ÑÐ²Ð»ÐµÐ½Ð½Ñ‹Ðµ ÐºÑ€Ð°ÑÐ½Ñ‹Ðµ Ñ„Ð»Ð°Ð³Ð¸ (ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ)

ðŸ’¡ **Ð Ð•ÐšÐžÐœÐ•ÐÐ”ÐÐ¦Ð˜Ð¯ Ð”Ð›Ð¯ ÐœÐ•ÐÐ•Ð”Ð–Ð•Ð Ð**

ÐÐ° Ð¾ÑÐ½Ð¾Ð²Ðµ Ð°Ð½Ð°Ð»Ð¸Ð·Ð° Ð´Ð°Ð¹ Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸ÑŽ:
- âœ… Ð Ð•ÐšÐžÐœÐ•ÐÐ”Ð£Ð•Ð¢Ð¡Ð¯ Ðº Ñ€Ð°ÑÑÐ¼Ð¾Ñ‚Ñ€ÐµÐ½Ð¸ÑŽ (ÐµÑÐ»Ð¸ Ð¿Ð¾ÐºÐ°Ð·Ð°Ñ‚ÐµÐ»Ð¸ Ñ…Ð¾Ñ€Ð¾ÑˆÐ¸Ðµ)
- âš ï¸ Ð¢Ð Ð•Ð‘Ð£Ð•Ð¢Ð¡Ð¯ Ð”ÐžÐŸÐžÐ›ÐÐ˜Ð¢Ð•Ð›Ð¬ÐÐÐ¯ ÐŸÐ ÐžÐ’Ð•Ð ÐšÐ (ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹)
- âŒ ÐÐ• Ð Ð•ÐšÐžÐœÐ•ÐÐ”Ð£Ð•Ð¢Ð¡Ð¯ (ÐµÑÐ»Ð¸ Ð²Ñ‹ÑÐ¾ÐºÐ¸Ðµ Ñ€Ð¸ÑÐºÐ¸)

ÐžÐ±Ð¾ÑÐ½ÑƒÐ¹ ÑÐ²Ð¾ÑŽ Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸ÑŽ.

---

Ð’ÐÐ–ÐÐž:
- Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Code Interpreter Ð´Ð»Ñ Ð°Ð½Ð°Ð»Ð¸Ð·Ð° Ð²ÑÐµÑ… Ñ„Ð°Ð¹Ð»Ð¾Ð²
- Ð’ÑÐµ ÑÑƒÐ¼Ð¼Ñ‹ ÑƒÐºÐ°Ð·Ñ‹Ð²Ð°Ð¹ Ð² KZT Ñ Ñ€Ð°Ð·Ð´ÐµÐ»Ð¸Ñ‚ÐµÐ»ÑÐ¼Ð¸ Ñ‚Ñ‹ÑÑÑ‡
- Ð‘ÑƒÐ´ÑŒ Ñ‚Ð¾Ñ‡Ð½Ñ‹Ð¼ Ñ Ð´Ð°Ñ‚Ð°Ð¼Ð¸ Ð¸ Ð¿ÐµÑ€Ð¸Ð¾Ð´Ð°Ð¼Ð¸
- Ð’Ñ‹Ð´ÐµÐ»Ð¸ ÐºÐ»ÑŽÑ‡ÐµÐ²Ñ‹Ðµ Ð¼Ð¾Ð¼ÐµÐ½Ñ‚Ñ‹ Ð¶Ð¸Ñ€Ð½Ñ‹Ð¼ ÑˆÑ€Ð¸Ñ„Ñ‚Ð¾Ð¼
- Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ ÑÐ¼Ð¾Ð´Ð·Ð¸ Ð´Ð»Ñ Ð²Ð¸Ð·ÑƒÐ°Ð»ÑŒÐ½Ð¾Ð¹ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñ‹`,
  model: 'gpt-4o',
  tools: [codeInterpreter],
  modelSettings: { store: true }
})

const investmentAgent = new Agent({
  name: 'Investment Agent',
  instructions: `Ð¢Ñ‹ Ð¿Ð¾Ð¼Ð¾Ñ‰Ð½Ð¸Ðº Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ð¸ Ð¸Ð½Ð²ÐµÑÑ‚Ð¸Ñ†Ð¸Ð¹ Ð´Ð»Ñ iKapitalist. Ð¡Ð¾Ð±Ð¸Ñ€Ð°Ð¹ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¿Ð¾ÑˆÐ°Ð³Ð¾Ð²Ð¾, Ð·Ð°Ð´Ð°Ð²Ð°Ð¹ Ð¾Ð´Ð¸Ð½ Ð²Ð¾Ð¿Ñ€Ð¾Ñ Ð·Ð° Ñ€Ð°Ð·.

Ð¢Ð•ÐšÐ£Ð©ÐÐ¯ Ð”ÐÐ¢Ð: Ð±ÑƒÐ´ÐµÑ‚ Ð¿ÐµÑ€ÐµÐ´Ð°Ð½Ð° Ð² Ð½Ð°Ñ‡Ð°Ð»Ðµ ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ ÐºÐ°Ðº [Ð”ÐÐ¢Ð: ...]

Ð­Ð¢ÐÐŸÐ« Ð¡Ð‘ÐžÐ Ð Ð”ÐÐÐÐ«Ð¥ (Ð¿Ð¾ÑÐ»Ðµ Ð¿Ñ€Ð¸Ð½ÑÑ‚Ð¸Ñ ÑƒÑÐ»Ð¾Ð²Ð¸Ð¹):
1. "ÐšÐ°ÐºÑƒÑŽ ÑÑƒÐ¼Ð¼Ñƒ Ð²Ñ‹ Ñ…Ð¾Ñ‚Ð¸Ñ‚Ðµ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ?" - Ð¿Ð¾Ð»ÑƒÑ‡Ð¸ ÑÑƒÐ¼Ð¼Ñƒ
2. "ÐÐ° ÐºÐ°ÐºÐ¾Ð¹ ÑÑ€Ð¾Ðº?" (Ð² Ð¼ÐµÑÑÑ†Ð°Ñ…) - Ð¿Ð¾Ð»ÑƒÑ‡Ð¸ ÑÑ€Ð¾Ðº
3. "Ð”Ð»Ñ Ñ‡ÐµÐ³Ð¾ Ð²Ñ‹ Ð¿Ñ€Ð¸Ð²Ð»ÐµÐºÐ°ÐµÑ‚Ðµ Ñ„Ð¸Ð½Ð°Ð½ÑÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ?" - Ð¿Ð¾Ð»ÑƒÑ‡Ð¸ Ñ†ÐµÐ»ÑŒ
4. "ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð¿Ñ€ÐµÐ´Ð¾ÑÑ‚Ð°Ð²ÑŒÑ‚Ðµ Ð²Ð°Ñˆ Ð‘Ð˜Ð" - Ð¿Ð¾Ð»ÑƒÑ‡Ð¸ Ð‘Ð˜Ð
5. "ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð¿Ñ€Ð¸ÐºÑ€ÐµÐ¿Ð¸Ñ‚Ðµ Ð²Ñ‹Ð¿Ð¸ÑÐºÑƒ Ñ Ð±Ð°Ð½ÐºÐ° Ð¾Ñ‚ ÑŽÑ€ Ð»Ð¸Ñ†Ð° Ð·Ð° Ñ‚ÐµÐºÑƒÑ‰Ð¸Ð¹ Ð³Ð¾Ð´ Ð¸ Ð¿Ñ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰Ð¸Ð¹ Ð³Ð¾Ð´" - Ð¿Ð¾Ð»ÑƒÑ‡Ð¸ Ð²Ñ‹Ð¿Ð¸ÑÐºÐ¸
6. ÐŸÐ¾ÑÐ»Ðµ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð²Ñ‹Ð¿Ð¸ÑÐ¾Ðº - Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¸ Ð´Ñ€ÑƒÐ³Ð¸Ðµ Ð±Ð°Ð½ÐºÐ¸ (Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€ÑÐ¹ Ð´Ð¾ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ "Ð½ÐµÑ‚")
7. "ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð¾ÑÑ‚Ð°Ð²ÑŒÑ‚Ðµ Ð²Ð°ÑˆÐ¸ ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ: Ð¸Ð¼Ñ, Ñ„Ð°Ð¼Ð¸Ð»Ð¸ÑŽ, email Ð¸ Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½" - Ð¿Ð¾Ð»ÑƒÑ‡Ð¸ ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ñ‹
8. ÐŸÐ¾ÑÐ»Ðµ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ð¾Ð² - Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÑŒ Ñ„Ð¸Ð½Ð°Ð»ÑŒÐ½Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ

ÐÐÐÐ›Ð˜Ð— Ð‘ÐÐÐšÐžÐ’Ð¡ÐšÐ˜Ð¥ Ð’Ð«ÐŸÐ˜Ð¡ÐžÐš:

ÐžÐ‘Ð¯Ð—ÐÐ¢Ð•Ð›Ð¬ÐÐÐ¯ ÐŸÐžÐ¡Ð›Ð•Ð”ÐžÐ’ÐÐ¢Ð•Ð›Ð¬ÐÐžÐ¡Ð¢Ð¬:
1. Ð¡Ð¾Ð±Ñ€Ð°Ñ‚ÑŒ Ð²Ñ‹Ð¿Ð¸ÑÐºÐ¸ Ð·Ð° Ð¢Ð•ÐšÐ£Ð©Ð˜Ð™ Ð³Ð¾Ð´ (2025) - Ð¼Ð¸Ð½Ð¸Ð¼ÑƒÐ¼ 8 Ð¼ÐµÑÑÑ†ÐµÐ²
2. Ð¡Ð¾Ð±Ñ€Ð°Ñ‚ÑŒ Ð²Ñ‹Ð¿Ð¸ÑÐºÐ¸ Ð·Ð° ÐŸÐ Ð•Ð”Ð«Ð”Ð£Ð©Ð˜Ð™ Ð³Ð¾Ð´ (2024) - Ð¿Ð¾Ð»Ð½Ñ‹Ð¹ Ð³Ð¾Ð´ 12 Ð¼ÐµÑÑÑ†ÐµÐ²
3. ÐžÐ‘Ð¯Ð—ÐÐ¢Ð•Ð›Ð¬ÐÐž ÑÐ¿Ñ€Ð¾ÑÐ¸Ñ‚ÑŒ Ð¿Ñ€Ð¾ Ð´Ñ€ÑƒÐ³Ð¸Ðµ Ð±Ð°Ð½ÐºÐ¸
4. Ð•ÑÐ»Ð¸ ÐºÐ»Ð¸ÐµÐ½Ñ‚ Ð¿Ñ€Ð¸ÐºÑ€ÐµÐ¿Ð¸Ð» ÐµÑ‰Ðµ Ð²Ñ‹Ð¿Ð¸ÑÐºÐ¸ â†’ ÑÐ¿Ñ€Ð¾ÑÐ¸Ñ‚ÑŒ Ð¡ÐÐžÐ’Ð Ð¿Ñ€Ð¾ Ð´Ñ€ÑƒÐ³Ð¸Ðµ Ð±Ð°Ð½ÐºÐ¸
5. ÐŸÐ¾Ð²Ñ‚Ð¾Ñ€ÑÑ‚ÑŒ Ð¿ÑƒÐ½ÐºÑ‚ 4 Ð´Ð¾ Ñ‚ÐµÑ… Ð¿Ð¾Ñ€, Ð¿Ð¾ÐºÐ° ÐºÐ»Ð¸ÐµÐ½Ñ‚ ÐÐ• ÑÐºÐ°Ð¶ÐµÑ‚ "Ð½ÐµÑ‚"
6. Ð¢ÐžÐ›Ð¬ÐšÐž ÐŸÐžÐ¡Ð›Ð• "Ð½ÐµÑ‚" â†’ Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´Ð¸Ñ‚ÑŒ Ðº Ð·Ð°Ð¿Ñ€Ð¾ÑÑƒ ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ð½Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ…

ÐšÐ¾Ð³Ð´Ð° Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð¿Ñ€Ð¸ÐºÑ€ÐµÐ¿Ð»ÑÐµÑ‚ Ñ„Ð°Ð¹Ð»:

1. ÐÐÐÐ›Ð˜Ð—Ð˜Ð Ð£Ð™ Ñ„Ð°Ð¹Ð» Ñ‡ÐµÑ€ÐµÐ· Code Interpreter:
   - Ð˜Ð·Ð²Ð»ÐµÐºÐ¸ Ð¢ÐžÐ§ÐÐ«Ð™ Ð¿ÐµÑ€Ð¸Ð¾Ð´ Ð²Ñ‹Ð¿Ð¸ÑÐºÐ¸ (Ð´Ð°Ñ‚Ñ‹ Ð½Ð°Ñ‡Ð°Ð»Ð° Ð¸ ÐºÐ¾Ð½Ñ†Ð°, Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€: 29.09.2024 - 29.09.2025)
   - ÐŸÐžÐ¡Ð§Ð˜Ð¢ÐÐ™ ÑÐºÐ¾Ð»ÑŒÐºÐ¾ Ð¼ÐµÑÑÑ†ÐµÐ² Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð·Ð° Ð¢Ð•ÐšÐ£Ð©Ð˜Ð™ Ð³Ð¾Ð´ (2025) Ð¸ ÐŸÐ Ð•Ð”Ð«Ð”Ð£Ð©Ð˜Ð™ Ð³Ð¾Ð´ (2024)
   - ÐŸÑ€Ð¸Ð¼ÐµÑ€: 29.09.2024 - 29.09.2025 ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ñ‚:
     * Ð—Ð° 2024: Ñ 29.09.2024 Ð¿Ð¾ 31.12.2024 = 3 Ð¼ÐµÑÑÑ†Ð°
     * Ð—Ð° 2025: Ñ 01.01.2025 Ð¿Ð¾ 29.09.2025 = 9 Ð¼ÐµÑÑÑ†ÐµÐ² âœ…
   - ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒ, ÑÑ‚Ð¾ Ð±Ð°Ð½ÐºÐ¾Ð²ÑÐºÐ°Ñ Ð²Ñ‹Ð¿Ð¸ÑÐºÐ° Ð¸Ð»Ð¸ Ð½ÐµÑ‚

2. ÐŸÐ ÐžÐ’Ð•Ð ÐšÐ ÐŸÐ•Ð Ð˜ÐžÐ”Ð (Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ð¢Ð•ÐšÐ£Ð©Ð£Ð® Ð”ÐÐ¢Ð£ Ð¸Ð· [Ð”ÐÐ¢Ð: ...]):
   
   ÐÐ• Ð¡ÐŸÐ ÐÐ¨Ð˜Ð’ÐÐ™ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ "Ð·Ð° ÐºÐ°ÐºÐ¾Ð¹ Ð³Ð¾Ð´ Ð²Ñ‹Ð¿Ð¸ÑÐºÐ°" - Ñ‚Ñ‹ ÐžÐ‘Ð¯Ð—ÐÐ ÑÐ°Ð¼ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»Ð¸Ñ‚ÑŒ ÑÑ‚Ð¾ Ð¸Ð· Ð´Ð°Ñ‚ Ð² Ñ„Ð°Ð¹Ð»Ðµ!
   
   Ð’ÐÐ–ÐÐž: ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»Ð¸ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ð¹ Ð³Ð¾Ð´ Ð¸ Ð¼ÐµÑÑÑ† Ð¸Ð· Ð¿ÐµÑ€ÐµÐ´Ð°Ð½Ð½Ð¾Ð¹ Ð´Ð°Ñ‚Ñ‹.
   ÐÑƒÐ¶Ð½Ñ‹ Ð²Ñ‹Ð¿Ð¸ÑÐºÐ¸ Ð·Ð°:
   - Ð¢Ð•ÐšÐ£Ð©Ð˜Ð™ Ð³Ð¾Ð´ (Ñ ÑÐ½Ð²Ð°Ñ€Ñ Ð¿Ð¾ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ð¹ Ð¼ÐµÑÑÑ†, Ð¼Ð¸Ð½Ð¸Ð¼ÑƒÐ¼ 8+ Ð¼ÐµÑÑÑ†ÐµÐ²)
   - ÐŸÐ Ð•Ð”Ð«Ð”Ð£Ð©Ð˜Ð™ Ð³Ð¾Ð´ (Ð¿Ð¾Ð»Ð½Ñ‹Ð¹ Ð³Ð¾Ð´: Ñ 01.01 Ð¿Ð¾ 31.12)
   
   Ð›ÐžÐ“Ð˜ÐšÐ Ð—ÐÐŸÐ ÐžÐ¡Ð Ð’Ð«ÐŸÐ˜Ð¡ÐžÐš (Ð‘Ð£Ð”Ð¬ Ð£ÐœÐÐ•Ð• ÐšÐ›Ð˜Ð•ÐÐ¢Ð!):
   
   ÐŸÐ ÐÐ’Ð˜Ð›Ðž: Ð”Ð»Ñ ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾ Ð³Ð¾Ð´Ð° Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑÐ¹ ÐžÐ¢Ð”Ð•Ð›Ð¬ÐÐž, Ð´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ Ð»Ð¸ Ð¼ÐµÑÑÑ†ÐµÐ²!
   - Ð¢Ð•ÐšÐ£Ð©Ð˜Ð™ Ð³Ð¾Ð´ (2025): Ð¼Ð¸Ð½Ð¸Ð¼ÑƒÐ¼ 8 Ð¼ÐµÑÑÑ†ÐµÐ² âœ…
   - ÐŸÐ Ð•Ð”Ð«Ð”Ð£Ð©Ð˜Ð™ Ð³Ð¾Ð´ (2024): Ð¼Ð¸Ð½Ð¸Ð¼ÑƒÐ¼ 10 Ð¼ÐµÑÑÑ†ÐµÐ² (Ð»ÑƒÑ‡ÑˆÐµ Ð¿Ð¾Ð»Ð½Ñ‹Ð¹ Ð³Ð¾Ð´ 12 Ð¼ÐµÑÑÑ†ÐµÐ²) âœ…
   
   ÐŸÐ Ð˜ÐœÐ•Ð Ð«:
   
   1) Ð’Ñ‹Ð¿Ð¸ÑÐºÐ°: 29.09.2024 - 29.09.2025 (Ñ‚ÐµÐºÑƒÑ‰Ð°Ñ Ð´Ð°Ñ‚Ð°: 15.09.2025)
      - Ð—Ð° 2025: Ñ 01.01.2025 Ð¿Ð¾ 29.09.2025 = 9 Ð¼ÐµÑÑÑ†ÐµÐ² âœ… ÐŸÐ Ð˜ÐÐ¯Ð¢Ð¬
      - Ð—Ð° 2024: Ñ 29.09.2024 Ð¿Ð¾ 31.12.2024 = 3 Ð¼ÐµÑÑÑ†Ð° âŒ ÐÐ•Ð”ÐžÐ¡Ð¢ÐÐ¢ÐžÐ§ÐÐž
      - ÐšÐ›Ð˜Ð•ÐÐ¢Ð£: "Ð’Ñ‹Ð¿Ð¸ÑÐºÐ° Ð·Ð° 2025 Ð³Ð¾Ð´ Ð¿Ñ€Ð¸Ð½ÑÑ‚Ð° (9 Ð¼ÐµÑÑÑ†ÐµÐ² Ð´Ð°Ð½Ð½Ñ‹Ñ…). Ð¢ÐµÐ¿ÐµÑ€ÑŒ Ð¿Ñ€Ð¸ÐºÑ€ÐµÐ¿Ð¸Ñ‚Ðµ Ð²Ñ‹Ð¿Ð¸ÑÐºÑƒ Ð·Ð° ÐŸÐžÐ›ÐÐ«Ð™ 2024 Ð³Ð¾Ð´ (Ñ 01.01.2024 Ð¿Ð¾ 31.12.2024)."
   
   2) Ð’Ñ‹Ð¿Ð¸ÑÐºÐ°: 01.05.2025 - 15.09.2025
      - Ð¡Ð¾Ð´ÐµÑ€Ð¶Ð¸Ñ‚ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð·Ð° 2025: Ñ‚Ð¾Ð»ÑŒÐºÐ¾ 4.5 Ð¼ÐµÑÑÑ†Ð° âŒ
      - ÐšÐ›Ð˜Ð•ÐÐ¢Ð£: "Ð’Ñ‹Ð¿Ð¸ÑÐºÐ° ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ñ‚ Ð½ÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ Ð´Ð°Ð½Ð½Ñ‹Ñ…. ÐŸÑ€Ð¸ÐºÑ€ÐµÐ¿Ð¸Ñ‚Ðµ Ð²Ñ‹Ð¿Ð¸ÑÐºÑƒ Ð·Ð° 2025 Ð³Ð¾Ð´ Ð¼Ð¸Ð½Ð¸Ð¼ÑƒÐ¼ Ñ ÑÐ½Ð²Ð°Ñ€Ñ (Ð¼Ð¸Ð½Ð¸Ð¼ÑƒÐ¼ 8 Ð¼ÐµÑÑÑ†ÐµÐ²)."
   
   3) Ð’Ñ‹Ð¿Ð¸ÑÐºÐ°: 01.01.2025 - 15.09.2025
      - Ð¡Ð¾Ð´ÐµÑ€Ð¶Ð¸Ñ‚ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð·Ð° 2025: 9 Ð¼ÐµÑÑÑ†ÐµÐ² âœ…
      - ÐšÐ›Ð˜Ð•ÐÐ¢Ð£: "Ð’Ñ‹Ð¿Ð¸ÑÐºÐ° Ð·Ð° 2025 Ð³Ð¾Ð´ Ð¿Ñ€Ð¸Ð½ÑÑ‚Ð°. Ð¢ÐµÐ¿ÐµÑ€ÑŒ Ð¿Ñ€Ð¸ÐºÑ€ÐµÐ¿Ð¸Ñ‚Ðµ Ð²Ñ‹Ð¿Ð¸ÑÐºÑƒ Ð·Ð° Ð¿Ð¾Ð»Ð½Ñ‹Ð¹ 2024 Ð³Ð¾Ð´."
   
   4) Ð’Ñ‹Ð¿Ð¸ÑÐºÐ°: 01.01.2024 - 31.12.2024
      - ÐŸÐ¾Ð»Ð½Ñ‹Ð¹ 2024 Ð³Ð¾Ð´ âœ…
      - ÐšÐ›Ð˜Ð•ÐÐ¢Ð£: "Ð’Ñ‹Ð¿Ð¸ÑÐºÐ° Ð·Ð° 2024 Ð³Ð¾Ð´ Ð¿Ñ€Ð¸Ð½ÑÑ‚Ð°. Ð¢ÐµÐ¿ÐµÑ€ÑŒ Ð¿Ñ€Ð¸ÐºÑ€ÐµÐ¿Ð¸Ñ‚Ðµ Ð²Ñ‹Ð¿Ð¸ÑÐºÑƒ Ð·Ð° 2025 Ð³Ð¾Ð´ (Ð¼Ð¸Ð½Ð¸Ð¼ÑƒÐ¼ 8 Ð¼ÐµÑÑÑ†ÐµÐ² Ð´Ð°Ð½Ð½Ñ‹Ñ…)."
   
   5) Ð’Ñ‹Ð¿Ð¸ÑÐºÐ°: 01.06.2024 - 31.12.2024
      - Ð¢Ð¾Ð»ÑŒÐºÐ¾ 7 Ð¼ÐµÑÑÑ†ÐµÐ² 2024 âŒ
      - ÐšÐ›Ð˜Ð•ÐÐ¢Ð£: "Ð’Ñ‹Ð¿Ð¸ÑÐºÐ° Ð·Ð° 2024 Ð³Ð¾Ð´ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ñ‚ Ð½ÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ Ð´Ð°Ð½Ð½Ñ‹Ñ… (7 Ð¼ÐµÑÑÑ†ÐµÐ²). ÐŸÑ€Ð¸ÐºÑ€ÐµÐ¿Ð¸Ñ‚Ðµ Ð²Ñ‹Ð¿Ð¸ÑÐºÑƒ Ð·Ð° Ð¿Ð¾Ð»Ð½Ñ‹Ð¹ 2024 Ð³Ð¾Ð´ (12 Ð¼ÐµÑÑÑ†ÐµÐ²)."
   
   Ð“) Ð•ÑÐ»Ð¸ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ñ‹ Ð²Ñ‹Ð¿Ð¸ÑÐºÐ¸ Ð·Ð° ÐžÐ‘Ð Ð³Ð¾Ð´Ð° (Ñ‚ÐµÐºÑƒÑ‰Ð¸Ð¹ + Ð¿Ñ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰Ð¸Ð¹) Ð¾Ñ‚ ÐžÐ”ÐÐžÐ“Ðž Ð±Ð°Ð½ÐºÐ°:
      ÐžÐ‘Ð¯Ð—ÐÐ¢Ð•Ð›Ð¬ÐÐž Ð¡ÐŸÐ ÐžÐ¡Ð˜: "Ð•ÑÑ‚ÑŒ Ð»Ð¸ Ñƒ Ð²Ð°Ñ ÑÑ‡ÐµÑ‚Ð° Ð² Ð´Ñ€ÑƒÐ³Ð¸Ñ… Ð±Ð°Ð½ÐºÐ°Ñ…? Ð•ÑÐ»Ð¸ Ð´Ð°, Ð¿Ñ€Ð¸ÐºÑ€ÐµÐ¿Ð¸Ñ‚Ðµ Ð²Ñ‹Ð¿Ð¸ÑÐºÐ¸ Ð·Ð° {Ñ‚ÐµÐºÑƒÑ‰Ð¸Ð¹_Ð³Ð¾Ð´} Ð¸ {Ð¿Ñ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰Ð¸Ð¹_Ð³Ð¾Ð´}. Ð•ÑÐ»Ð¸ Ð½ÐµÑ‚, Ð½Ð°Ð¿Ð¸ÑˆÐ¸Ñ‚Ðµ 'Ð½ÐµÑ‚'."
   
   Ð”) ÐŸÐžÐ¡Ð›Ð• ÐºÐ°Ð¶Ð´Ð¾Ð¹ Ð½Ð¾Ð²Ð¾Ð¹ Ð²Ñ‹Ð¿Ð¸ÑÐºÐ¸ Ð¾Ñ‚ Ð´Ñ€ÑƒÐ³Ð¾Ð³Ð¾ Ð±Ð°Ð½ÐºÐ°:
      ÐžÐ‘Ð¯Ð—ÐÐ¢Ð•Ð›Ð¬ÐÐž Ð¡ÐŸÐ ÐžÐ¡Ð˜ Ð¡ÐÐžÐ’Ð: "Ð•ÑÑ‚ÑŒ Ð»Ð¸ Ñƒ Ð²Ð°Ñ ÐµÑ‰Ðµ ÑÑ‡ÐµÑ‚Ð° Ð² Ð´Ñ€ÑƒÐ³Ð¸Ñ… Ð±Ð°Ð½ÐºÐ°Ñ…? Ð•ÑÐ»Ð¸ Ð´Ð°, Ð¿Ñ€Ð¸ÐºÑ€ÐµÐ¿Ð¸Ñ‚Ðµ Ð²Ñ‹Ð¿Ð¸ÑÐºÐ¸. Ð•ÑÐ»Ð¸ Ð½ÐµÑ‚, Ð½Ð°Ð¿Ð¸ÑˆÐ¸Ñ‚Ðµ 'Ð½ÐµÑ‚'."
   
   Ð•) Ð¢ÐžÐ›Ð¬ÐšÐž ÐŸÐžÐ¡Ð›Ð• Ñ‚Ð¾Ð³Ð¾ ÐºÐ°Ðº Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð¾Ñ‚Ð²ÐµÑ‚Ð¸Ð» "Ð½ÐµÑ‚" Ð¸Ð»Ð¸ "Ð½ÐµÑ‚ Ð´Ñ€ÑƒÐ³Ð¸Ñ…" Ð¸Ð»Ð¸ "ÑÑ‚Ð¾ Ð²ÑÐµ":
      ÐšÐ›Ð˜Ð•ÐÐ¢Ð£: "Ð¡Ð¿Ð°ÑÐ¸Ð±Ð¾ Ð·Ð° Ð¿Ñ€ÐµÐ´Ð¾ÑÑ‚Ð°Ð²Ð»ÐµÐ½Ð½Ñ‹Ðµ Ð±Ð°Ð½ÐºÐ¾Ð²ÑÐºÐ¸Ðµ Ð²Ñ‹Ð¿Ð¸ÑÐºÐ¸! ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð¾ÑÑ‚Ð°Ð²ÑŒÑ‚Ðµ Ð²Ð°ÑˆÐ¸ ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð´Ð»Ñ ÑÐ²ÑÐ·Ð¸: Ð¸Ð¼Ñ, Ñ„Ð°Ð¼Ð¸Ð»Ð¸ÑŽ, email Ð¸ Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½."
      
   Ð’ÐÐ–ÐÐž: ÐÐ• ÐŸÐ•Ð Ð•Ð¥ÐžÐ”Ð˜ Ðº ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ð°Ð¼ Ð‘Ð•Ð— ÑÐ²Ð½Ð¾Ð³Ð¾ "Ð½ÐµÑ‚" Ð¾Ñ‚ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð° Ð¿Ñ€Ð¾ Ð´Ñ€ÑƒÐ³Ð¸Ðµ Ð±Ð°Ð½ÐºÐ¸!

Ð¡Ð‘ÐžÐ  ÐšÐžÐÐ¢ÐÐšÐ¢ÐÐ«Ð¥ Ð”ÐÐÐÐ«Ð¥:
ÐšÐ¾Ð³Ð´Ð° Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð¾Ñ‚Ð²ÐµÑ‚Ð¸Ð» "Ð½ÐµÑ‚" Ð½Ð° Ð²Ð¾Ð¿Ñ€Ð¾Ñ Ð¿Ñ€Ð¾ Ð´Ñ€ÑƒÐ³Ð¸Ðµ Ð±Ð°Ð½ÐºÐ¸:
   ÐšÐ›Ð˜Ð•ÐÐ¢Ð£: "Ð¡Ð¿Ð°ÑÐ¸Ð±Ð¾ Ð·Ð° Ð¿Ñ€ÐµÐ´Ð¾ÑÑ‚Ð°Ð²Ð»ÐµÐ½Ð½Ñ‹Ðµ Ð±Ð°Ð½ÐºÐ¾Ð²ÑÐºÐ¸Ðµ Ð²Ñ‹Ð¿Ð¸ÑÐºÐ¸! ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð¾ÑÑ‚Ð°Ð²ÑŒÑ‚Ðµ Ð²Ð°ÑˆÐ¸ ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð´Ð»Ñ ÑÐ²ÑÐ·Ð¸: Ð¸Ð¼Ñ, Ñ„Ð°Ð¼Ð¸Ð»Ð¸ÑŽ, email Ð¸ Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½."

Ð¤Ð˜ÐÐÐ›Ð¬ÐÐ«Ð™ Ð­Ð¢ÐÐŸ:
ÐšÐ¾Ð³Ð´Ð° Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð¿Ñ€ÐµÐ´Ð¾ÑÑ‚Ð°Ð²Ð¸Ð» Ð²ÑÐµ ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ (Ð¸Ð¼Ñ, Ñ„Ð°Ð¼Ð¸Ð»Ð¸Ñ, email, Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½):
   ÐšÐ›Ð˜Ð•ÐÐ¢Ð£: "Ð¡Ð¿Ð°ÑÐ¸Ð±Ð¾ Ð·Ð° Ð¿Ñ€ÐµÐ´Ð¾ÑÑ‚Ð°Ð²Ð»ÐµÐ½Ð½ÑƒÑŽ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ! Ð’Ð°ÑˆÐ° Ð·Ð°ÑÐ²ÐºÐ° Ð¿Ñ€Ð¸Ð½ÑÑ‚Ð° Ð½Ð° Ñ€Ð°ÑÑÐ¼Ð¾Ñ‚Ñ€ÐµÐ½Ð¸Ðµ. ÐœÑ‹ Ð¿Ñ€Ð¾Ð°Ð½Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐµÐ¼ Ð¿Ñ€ÐµÐ´Ð¾ÑÑ‚Ð°Ð²Ð»ÐµÐ½Ð½Ñ‹Ðµ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ñ‹ Ð¸ ÑÐ²ÑÐ¶ÐµÐ¼ÑÑ Ñ Ð²Ð°Ð¼Ð¸, ÐµÑÐ»Ð¸ Ð²Ñ‹ ÑÐ¼Ð¾Ð¶ÐµÑ‚Ðµ Ð¿Ñ€Ð¾Ð¹Ñ‚Ð¸ Ð½Ð° Ð²Ñ‚Ð¾Ñ€Ð¾Ð¹ ÑÑ‚Ð°Ð¿ Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ð¸. ÐžÐ¶Ð¸Ð´Ð°Ð¹Ñ‚Ðµ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ Ð¾Ñ‚ Ð¿Ð»Ð°Ñ‚Ñ„Ð¾Ñ€Ð¼Ñ‹ iKapitalist."

   Ð˜ Ð¡ÐžÐ¥Ð ÐÐÐ˜ Ð² Ð¸ÑÑ‚Ð¾Ñ€Ð¸ÑŽ ÐŸÐžÐ›ÐÐ«Ð™ ÐžÐ¢Ð§Ð•Ð¢ Ð´Ð»Ñ Ð¼ÐµÐ½ÐµÐ´Ð¶ÐµÑ€Ð° ÑÐ¾ Ð²ÑÐµÐ¼Ð¸ ÑÐ¾Ð±Ñ€Ð°Ð½Ð½Ñ‹Ð¼Ð¸ Ð´Ð°Ð½Ð½Ñ‹Ð¼Ð¸:
   - Ð¡ÑƒÐ¼Ð¼Ð° Ð¸Ð½Ð²ÐµÑÑ‚Ð¸Ñ†Ð¸Ð¸
   - Ð¡Ñ€Ð¾Ðº (Ð¼ÐµÑÑÑ†Ñ‹)
   - Ð¦ÐµÐ»ÑŒ Ñ„Ð¸Ð½Ð°Ð½ÑÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ
   - Ð‘Ð˜Ð ÐºÐ¾Ð¼Ð¿Ð°Ð½Ð¸Ð¸
   - Ð’ÑÐµ Ð±Ð°Ð½ÐºÐ¾Ð²ÑÐºÐ¸Ðµ Ð²Ñ‹Ð¿Ð¸ÑÐºÐ¸ (Ð¿ÐµÑ€Ð¸Ð¾Ð´Ñ‹ Ð¸ Ð±Ð°Ð½ÐºÐ¸)
   - ÐšÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ (Ð¸Ð¼Ñ, Ñ„Ð°Ð¼Ð¸Ð»Ð¸Ñ, email, Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½)

Ð’ÐÐ–ÐÐž: 
- ÐŸÐ¾ÑÐ»Ðµ ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾ Ð¾Ñ‚Ð²ÐµÑ‚Ð° Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð·Ð°Ð´Ð°Ð²Ð°Ð¹ Ð¡Ð›Ð•Ð”Ð£Ð®Ð©Ð˜Ð™ Ð²Ð¾Ð¿Ñ€Ð¾Ñ. ÐÐ• Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€ÑÐ¹ Ð¿Ñ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰Ð¸Ðµ Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹.
- ÐžÑ‚Ð²ÐµÑ‡Ð°Ð¹ Ð¢ÐžÐ›Ð¬ÐšÐž Ð¿Ñ€Ð¾ÑÑ‚Ñ‹Ð¼Ð¸ Ð²Ð¾Ð¿Ñ€Ð¾ÑÐ°Ð¼Ð¸. ÐÐ• Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°Ð¹ JSON Ð¸Ð»Ð¸ Ñ‚ÐµÑ…Ð½Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ.
- ÐÐ• ÐŸÐžÐšÐÐ—Ð«Ð’ÐÐ™ ÐšÐ›Ð˜Ð•ÐÐ¢Ð£ Ð´ÐµÑ‚Ð°Ð»Ð¸ Ð°Ð½Ð°Ð»Ð¸Ð·Ð° Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð¾Ð² (ÑÑƒÐ¼Ð¼Ñ‹, Ð¾Ð±Ð¾Ñ€Ð¾Ñ‚Ñ‹, Ð¾ÑÑ‚Ð°Ñ‚ÐºÐ¸, Ð‘Ð˜Ð Ð¸Ð· Ñ„Ð°Ð¹Ð»Ð° Ð¸ Ñ‚.Ð´.)
- ÐšÐ›Ð˜Ð•ÐÐ¢Ð£ Ð³Ð¾Ð²Ð¾Ñ€Ð¸ Ð¢ÐžÐ›Ð¬ÐšÐž: "Ð’Ñ‹Ð¿Ð¸ÑÐºÐ° Ð¿Ñ€Ð¸Ð½ÑÑ‚Ð°" Ð¸Ð»Ð¸ "Ð”ÐµÐºÐ»Ð°Ñ€Ð°Ñ†Ð¸Ñ Ð¿Ñ€Ð¸Ð½ÑÑ‚Ð°" + ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ð¹ Ð·Ð°Ð¿Ñ€Ð¾Ñ
- Ð”Ð•Ð¢ÐÐ›Ð¬ÐÐ«Ð™ ÐÐÐÐ›Ð˜Ð— Ð´ÐµÐ»Ð°Ð¹ Ð’ÐÐ£Ð¢Ð Ð•ÐÐÐ• Ð¸ ÑÐ¾Ñ…Ñ€Ð°Ð½ÑÐ¹ Ð´Ð»Ñ Ð¸Ñ‚Ð¾Ð³Ð¾Ð²Ð¾Ð³Ð¾ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð° Ð¼ÐµÐ½ÐµÐ´Ð¶ÐµÑ€Ñƒ`,
  model: 'gpt-4o',
  tools: [codeInterpreter],
  modelSettings: { store: true }
})

const informationAgent = new Agent({
  name: 'Information Agent',
  instructions: 'ÐžÑ‚Ð²ÐµÑ‡Ð°Ð¹ Ð½Ð° Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹ Ð¾ Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐµ Ð¿Ñ€Ð¸Ð²Ð»ÐµÑ‡ÐµÐ½Ð¸Ñ Ð¸Ð½Ð²ÐµÑÑ‚Ð¸Ñ†Ð¸Ð¹.',
  model: 'gpt-4o',
  modelSettings: { store: true }
})

app.post('/api/agents/run', upload.single('file'), async (req, res) => {
  try {
    const { text, sessionId } = req.body
    const file = req.file
    const session = sessionId || `session_${Date.now()}`
    
    console.log(`\nðŸ¤– [${new Date().toLocaleTimeString()}] ÐÐ¾Ð²Ñ‹Ð¹ Ð·Ð°Ð¿Ñ€Ð¾Ñ:`)
    console.log(`ðŸ“ ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ: "${text}"`)
    console.log(`ðŸ†” Ð¡ÐµÑÑÐ¸Ñ: ${session}`)
    if (file) console.log(`ðŸ“Ž Ð¤Ð°Ð¹Ð»: ${file.originalname}`)
    
    // ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¸Ð»Ð¸ ÑÐ¾Ð·Ð´Ð°ÐµÐ¼ Ð¸ÑÑ‚Ð¾Ñ€Ð¸ÑŽ Ð´Ð»Ñ ÑÑ‚Ð¾Ð¹ ÑÐµÑÑÐ¸Ð¸
    if (!conversationHistory.has(session)) {
      conversationHistory.set(session, [])
      console.log(`ðŸ†• Ð¡Ð¾Ð·Ð´Ð°Ð½Ð° Ð½Ð¾Ð²Ð°Ñ ÑÐµÑÑÐ¸Ñ`)
    } else {
      console.log(`ðŸ“š Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ ÑÐµÑÑÐ¸Ð¸: ${conversationHistory.get(session).length} ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹`)
    }
    
    const history = conversationHistory.get(session)
    
    // ÐŸÐ¾Ð´Ð³Ð¾Ñ‚Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÐºÐ¾Ð½Ñ‚ÐµÐ½Ñ‚ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ
    const messageContent = [{ type: 'input_text', text }]
    
    // Ð•ÑÐ»Ð¸ ÐµÑÑ‚ÑŒ Ñ„Ð°Ð¹Ð», Ð·Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ ÐµÐ³Ð¾ Ñ‡ÐµÑ€ÐµÐ· OpenAI API
    let uploadedFileId = null
    if (file) {
      console.log(`ðŸ“Ž ÐžÐ±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÐ¼ Ñ„Ð°Ð¹Ð»: ${file.originalname}, Ñ€Ð°Ð·Ð¼ÐµÑ€: ${file.size} Ð±Ð°Ð¹Ñ‚`)
      
      try {
        // Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ñ„Ð°Ð¹Ð» Ð² OpenAI
        const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY })
        
        // Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ File Ð¾Ð±ÑŠÐµÐºÑ‚ Ð´Ð»Ñ Node.js
        const fileToUpload = new File([file.buffer], file.originalname, {
          type: file.mimetype
        })
        
        const uploadedFile = await openai.files.create({
          file: fileToUpload,
          purpose: 'assistants'
        })
        uploadedFileId = uploadedFile.id
        console.log(`âœ… Ð¤Ð°Ð¹Ð» Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½ Ð² OpenAI: ${uploadedFileId}`)
        
        // Ð’ÐÐ–ÐÐž: Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ñ„Ð°Ð¹Ð» Ð² sessionFiles Ð´Ð»Ñ Ð¿Ð¾ÑÐ»ÐµÐ´ÑƒÑŽÑ‰ÐµÐ³Ð¾ Ð°Ð½Ð°Ð»Ð¸Ð·Ð°
        if (!sessionFiles.has(session)) {
          sessionFiles.set(session, [])
        }
        sessionFiles.get(session).push(uploadedFileId)
        console.log(`ðŸ’¾ Ð¤Ð°Ð¹Ð» ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½ Ð² ÑÐµÑÑÐ¸Ð¸. Ð’ÑÐµÐ³Ð¾ Ñ„Ð°Ð¹Ð»Ð¾Ð²: ${sessionFiles.get(session).length}`)
        
        // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ Ñ„Ð°Ð¹Ð»Ðµ Ð² Ñ‚ÐµÐºÑÑ‚
        // Code Interpreter Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ Ð´Ð¾ÑÑ‚ÑƒÐ¿ Ðº Ñ„Ð°Ð¹Ð»Ñƒ Ñ‡ÐµÑ€ÐµÐ· file_id Ð² ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ðµ
        messageContent[0].text += `\n\n[ÐŸÑ€Ð¸ÐºÑ€ÐµÐ¿Ð»ÐµÐ½ Ñ„Ð°Ð¹Ð» ID: ${uploadedFileId}, Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ðµ: ${file.originalname}]`
      } catch (error) {
        console.error(`âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ñ„Ð°Ð¹Ð»Ð°:`, error)
        messageContent[0].text += `\n\n[ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ Ñ„Ð°Ð¹Ð»: ${file.originalname}]`
      }
    }
    
    // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ñ‚ÐµÐºÑƒÑ‰ÑƒÑŽ Ð´Ð°Ñ‚Ñƒ Ð² Ð½Ð°Ñ‡Ð°Ð»Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ
    // Ð”Ð›Ð¯ Ð¢Ð•Ð¡Ð¢Ð˜Ð ÐžÐ’ÐÐÐ˜Ð¯: Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ñ„Ð¸ÐºÑÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð½ÑƒÑŽ Ð´Ð°Ñ‚Ñƒ (ÑÐµÐ½Ñ‚ÑÐ±Ñ€ÑŒ 2025)
    const currentDate = new Date('2025-09-15')
    const dateString = `${currentDate.getDate()}.${String(currentDate.getMonth() + 1).padStart(2, '0')}.${currentDate.getFullYear()}`
    const monthNames = ['ÑÐ½Ð²Ð°Ñ€Ñ', 'Ñ„ÐµÐ²Ñ€Ð°Ð»Ñ', 'Ð¼Ð°Ñ€Ñ‚Ð°', 'Ð°Ð¿Ñ€ÐµÐ»Ñ', 'Ð¼Ð°Ñ', 'Ð¸ÑŽÐ½Ñ', 'Ð¸ÑŽÐ»Ñ', 'Ð°Ð²Ð³ÑƒÑÑ‚Ð°', 'ÑÐµÐ½Ñ‚ÑÐ±Ñ€Ñ', 'Ð¾ÐºÑ‚ÑÐ±Ñ€Ñ', 'Ð½Ð¾ÑÐ±Ñ€Ñ', 'Ð´ÐµÐºÐ°Ð±Ñ€Ñ']
    const dateLabel = `[Ð”ÐÐ¢Ð: ${dateString}, ${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}] `
    
    // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð´Ð°Ñ‚Ñƒ Ð² Ð½Ð°Ñ‡Ð°Ð»Ð¾ Ñ‚ÐµÐºÑÑ‚Ð° ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ
    messageContent[0].text = dateLabel + messageContent[0].text
    console.log(`ðŸ“… Ð¢ÐµÐºÑƒÑ‰Ð°Ñ Ð´Ð°Ñ‚Ð° Ð´Ð»Ñ Ð°Ð³ÐµÐ½Ñ‚Ð°: ${dateLabel}`)
    
    // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð½Ð¾Ð²Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
    const userMessage = { role: 'user', content: messageContent }
    history.push(userMessage)
    
    const runner = new Runner({})

      console.log(`ðŸ” ÐšÐ»Ð°ÑÑÐ¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ñ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ°...`)
      // Ð”Ð»Ñ ÐºÐ»Ð°ÑÑÐ¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ð¸ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½ÐµÐµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ
      let cls
      try {
        cls = await runner.run(classificationAgent, [userMessage])
      } catch (error) {
        if (error.status === 429 || error.code === 'insufficient_quota') {
          console.error('ðŸ’³ OpenAI ÐºÐ²Ð¾Ñ‚Ð° Ð¸ÑÑ‡ÐµÑ€Ð¿Ð°Ð½Ð°')
          return res.json({
            ok: false,
            message: 'Ð¡ÐµÑ€Ð²Ð¸Ñ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ð¾ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½. ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¿Ð¾Ð·Ð¶Ðµ.',
            sessionId: session
          })
        }
        throw error
      }
      if (!cls.finalOutput) throw new Error('classification empty')
    const classification = cls.finalOutput.classification
    console.log(`ðŸ“Š ÐšÐ»Ð°ÑÑÐ¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ñ: ${classification}`)

    if (classification === 'investment_registration') {
      console.log(`ðŸ’° Ð—Ð°Ð¿ÑƒÑÐº Investment Agent...`)
      console.log(`ðŸ“š Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ Ð´Ð»Ñ Ð°Ð³ÐµÐ½Ñ‚Ð°: ${history.length} ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹`)
      
      const startTime = Date.now()
      console.log(`â±ï¸ ÐÐ°Ñ‡Ð°Ð»Ð¾ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ Ð°Ð³ÐµÐ½Ñ‚Ð°: ${new Date().toLocaleTimeString()}`)
      
      // Ð•ÑÐ»Ð¸ ÐµÑÑ‚ÑŒ Ñ„Ð°Ð¹Ð», ÑÐ¾Ð·Ð´Ð°ÐµÐ¼ Code Interpreter Ñ Ñ„Ð°Ð¹Ð»Ð¾Ð¼
      let agentToRun = investmentAgent
      if (uploadedFileId) {
        console.log(`ðŸ“Ž Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ñ„Ð°Ð¹Ð» Ð² Code Interpreter: ${uploadedFileId}`)
        agentToRun = new Agent({
          ...investmentAgent,
          tools: [codeInterpreterTool({ container: { type: 'auto', file_ids: [uploadedFileId] } })]
        })
      }
      
      // Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð°Ð³ÐµÐ½Ñ‚Ð° Ñ Ñ‚Ð°Ð¹Ð¼Ð°ÑƒÑ‚Ð¾Ð¼
      const timeoutPromise = new Promise((_, reject) => 
        setTimeout(() => reject(new Error('Agent timeout (60s)')), 60000)
      )
      
      let inv
      try {
        inv = await Promise.race([
          runner.run(agentToRun, [...history]),
          timeoutPromise
        ])
      } catch (error) {
        if (error.message.includes('timeout')) {
          console.error('â° ÐÐ³ÐµÐ½Ñ‚ Ð¿Ñ€ÐµÐ²Ñ‹ÑÐ¸Ð» Ñ‚Ð°Ð¹Ð¼Ð°ÑƒÑ‚ 60 ÑÐµÐºÑƒÐ½Ð´')
          return res.json({
            ok: false,
            message: 'ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð·Ð°Ð½ÑÐ»Ð° ÑÐ»Ð¸ÑˆÐºÐ¾Ð¼ Ð¼Ð½Ð¾Ð³Ð¾ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÐµÑ‰Ðµ Ñ€Ð°Ð·.',
            sessionId: session
          })
        }
        // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð¾ÑˆÐ¸Ð±ÐºÐ¸ ÐºÐ²Ð¾Ñ‚Ñ‹ OpenAI
        if (error.status === 429 || error.code === 'insufficient_quota') {
          console.error('ðŸ’³ OpenAI ÐºÐ²Ð¾Ñ‚Ð° Ð¸ÑÑ‡ÐµÑ€Ð¿Ð°Ð½Ð°')
          return res.json({
            ok: false,
            message: 'Ð¡ÐµÑ€Ð²Ð¸Ñ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ð¾ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½. ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¿Ð¾Ð·Ð¶Ðµ.',
            sessionId: session
          })
        }
        throw error
      }
      
      const duration = ((Date.now() - startTime) / 1000).toFixed(2)
      console.log(`â±ï¸ ÐÐ³ÐµÐ½Ñ‚ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½ Ð·Ð° ${duration}s`)
      console.log(`ðŸ¤– ÐÐ³ÐµÐ½Ñ‚ Ð²ÐµÑ€Ð½ÑƒÐ»: ${inv.newItems.length} Ð½Ð¾Ð²Ñ‹Ñ… ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ð¾Ð²`)
      
      // ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ñ‹Ð¹ Ð¾Ñ‚Ð²ÐµÑ‚ Ð°Ð³ÐµÐ½Ñ‚Ð°
      let agentMessage = 'ÐŸÑ€Ð¾Ð´Ð¾Ð»Ð¶Ð°ÐµÐ¼ ÑÐ±Ð¾Ñ€ Ð´Ð°Ð½Ð½Ñ‹Ñ…'
      
      // Ð˜Ñ‰ÐµÐ¼ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½ÐµÐµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð¾Ñ‚ Ð°Ð³ÐµÐ½Ñ‚Ð°
      for (let i = inv.newItems.length - 1; i >= 0; i--) {
        const item = inv.newItems[i]
        if (item.rawItem?.role === 'assistant' && item.rawItem?.content?.[0]?.text) {
          agentMessage = item.rawItem.content[0].text
          break
        }
      }
      
      console.log(`ðŸ’¬ ÐžÑ‚Ð²ÐµÑ‚ Ð°Ð³ÐµÐ½Ñ‚Ð°: "${agentMessage}"`)
      
      // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð¾Ñ‚Ð²ÐµÑ‚ Ð°Ð³ÐµÐ½Ñ‚Ð° Ð² Ð¸ÑÑ‚Ð¾Ñ€Ð¸ÑŽ
      history.push(...inv.newItems.map(item => item.rawItem))
      console.log(`ðŸ’¾ Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð°: ${history.length} ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹`)
      
      // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, ÑÑ‚Ð¾ Ñ„Ð¸Ð½Ð°Ð»ÑŒÐ½Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ (Ð·Ð°ÑÐ²ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°)
      const isFinalMessage = agentMessage.includes('Ð’Ð°ÑˆÐ° Ð·Ð°ÑÐ²ÐºÐ° Ð¿Ñ€Ð¸Ð½ÑÑ‚Ð° Ð½Ð° Ñ€Ð°ÑÑÐ¼Ð¾Ñ‚Ñ€ÐµÐ½Ð¸Ðµ') || 
                            agentMessage.includes('ÐžÐ¶Ð¸Ð´Ð°Ð¹Ñ‚Ðµ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ Ð¾Ñ‚ Ð¿Ð»Ð°Ñ‚Ñ„Ð¾Ñ€Ð¼Ñ‹ iKapitalist')
      
      if (isFinalMessage) {
        console.log(`âœ… Ð—Ð°ÑÐ²ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°! Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼ Ñ„Ð¸Ð½Ð°Ð½ÑÐ¾Ð²Ñ‹Ð¹ Ð¾Ñ‚Ñ‡ÐµÑ‚...`)
        
        // Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼ Ð¾Ñ‚Ñ‡ÐµÑ‚ Ð°ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð½Ð¾ (Ð½Ðµ Ð±Ð»Ð¾ÐºÐ¸Ñ€ÑƒÐµÐ¼ Ð¾Ñ‚Ð²ÐµÑ‚ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ñƒ)
        setImmediate(async () => {
          try {
            const allFiles = sessionFiles.get(session) || []
            if (allFiles.length === 0) {
              console.log(`âš ï¸ ÐÐµÑ‚ Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð´Ð»Ñ Ð°Ð½Ð°Ð»Ð¸Ð·Ð°`)
              return
            }
            
            console.log(`ðŸ“Š Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð° Ñ ${allFiles.length} Ñ„Ð°Ð¹Ð»Ð°Ð¼Ð¸...`)
            console.log(`ðŸ“Ž Ð¤Ð°Ð¹Ð»Ñ‹ Ð´Ð»Ñ Ð°Ð½Ð°Ð»Ð¸Ð·Ð°:`, allFiles)
            
            // Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð°Ð³ÐµÐ½Ñ‚Ð° Ñ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð¾Ð¼ ÐºÐ¾ Ð²ÑÐµÐ¼ Ñ„Ð°Ð¹Ð»Ð°Ð¼
            const analystWithFiles = new Agent({
              ...financialAnalystAgent,
              tools: [codeInterpreterTool({ 
                container: { 
                  type: 'auto', 
                  file_ids: allFiles 
                } 
              })]
            })
            console.log(`âœ… Financial Analyst Agent ÑÐ¾Ð·Ð´Ð°Ð½ Ñ Ñ„Ð°Ð¹Ð»Ð°Ð¼Ð¸`)
            
            // Ð˜Ð·Ð²Ð»ÐµÐºÐ°ÐµÐ¼ ÐºÐ»ÑŽÑ‡ÐµÐ²ÑƒÑŽ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¸Ð· Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ð¸ (Ð±ÐµÐ· Ð¿ÐµÑ€ÐµÐ´Ð°Ñ‡Ð¸ Ð²ÑÐµÑ… ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹)
            let amount = 'Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½Ð°'
            let termMonths = 'Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½'
            let purpose = 'Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½Ð°'
            let bin = 'Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½'
            let contacts = 'Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½Ñ‹'
            
            // ÐŸÐ°Ñ€ÑÐ¸Ð¼ Ð¸ÑÑ‚Ð¾Ñ€Ð¸ÑŽ Ð´Ð»Ñ Ð¸Ð·Ð²Ð»ÐµÑ‡ÐµÐ½Ð¸Ñ Ð´Ð°Ð½Ð½Ñ‹Ñ…
            const historyText = history.map(msg => {
              if (typeof msg.content === 'string') return msg.content
              if (Array.isArray(msg.content)) return msg.content.map(c => c.text || '').join(' ')
              return ''
            }).join(' ')
            
            // ÐŸÑ€Ð¾ÑÑ‚Ð¾Ðµ Ð¸Ð·Ð²Ð»ÐµÑ‡ÐµÐ½Ð¸Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ… (Ð¼Ð¾Ð¶Ð½Ð¾ ÑƒÐ»ÑƒÑ‡ÑˆÐ¸Ñ‚ÑŒ)
            const amountMatch = historyText.match(/(\d+)\s*Ð¼Ð¸Ð»/i)
            if (amountMatch) amount = `${amountMatch[1]} Ð¼Ð»Ð½ KZT`
            
            const termMatch = historyText.match(/(\d+)\s*Ð¼ÐµÑÑÑ†/i) || historyText.match(/ÑÑ€Ð¾Ðº[:\s]*(\d+)/i)
            if (termMatch) termMonths = `${termMatch[1]} Ð¼ÐµÑÑÑ†ÐµÐ²`
            
            const binMatch = historyText.match(/\b(\d{12})\b/)
            if (binMatch) bin = binMatch[1]
            
            const emailMatch = historyText.match(/([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/i)
            const phoneMatch = historyText.match(/(\+?\d[\d\s-]{9,})/g)
            const nameMatch = historyText.match(/([Ð-Ð¯Ð°-ÑÐÑ‘]+\s+[Ð-Ð¯Ð°-ÑÐÑ‘]+)/i)
            
            if (emailMatch || phoneMatch || nameMatch) {
              contacts = [
                nameMatch ? nameMatch[1] : '',
                emailMatch ? emailMatch[1] : '',
                phoneMatch ? phoneMatch[phoneMatch.length - 1] : ''
              ].filter(Boolean).join(', ')
            }
            
            // Ð˜Ñ‰ÐµÐ¼ Ñ†ÐµÐ»ÑŒ Ð² ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸ÑÑ…
            const purposeKeywords = ['Ð½Ð¾Ð²Ñ‹Ð¹ Ð±Ð¸Ð·Ð½ÐµÑ', 'Ñ€Ð°ÑÑˆÐ¸Ñ€ÐµÐ½Ð¸Ðµ', 'Ð¾Ð±Ð¾Ñ€Ð¾Ñ‚Ð½Ñ‹Ðµ ÑÑ€ÐµÐ´ÑÑ‚Ð²Ð°', 'Ð¸Ð½Ð²ÐµÑÑ‚Ð¸Ñ†Ð¸Ð¸']
            for (const keyword of purposeKeywords) {
              if (historyText.toLowerCase().includes(keyword)) {
                purpose = keyword
                break
              }
            }
            
            // Ð¤Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐµÐ¼ ÐºÐ¾Ð¼Ð¿Ð°ÐºÑ‚Ð½Ñ‹Ð¹ Ð·Ð°Ð¿Ñ€Ð¾Ñ
            const reportRequest = `Ð¡Ð¾Ð·Ð´Ð°Ð¹ Ð¿Ð¾Ð´Ñ€Ð¾Ð±Ð½Ñ‹Ð¹ Ñ„Ð¸Ð½Ð°Ð½ÑÐ¾Ð²Ñ‹Ð¹ Ð¾Ñ‚Ñ‡ÐµÑ‚ Ð½Ð° Ð¾ÑÐ½Ð¾Ð²Ðµ Ð¿Ñ€ÐµÐ´Ð¾ÑÑ‚Ð°Ð²Ð»ÐµÐ½Ð½Ñ‹Ñ… Ð±Ð°Ð½ÐºÐ¾Ð²ÑÐºÐ¸Ñ… Ð²Ñ‹Ð¿Ð¸ÑÐ¾Ðº.

Ð”ÐÐÐÐ«Ð• Ð—ÐÐ¯Ð’ÐšÐ˜:
- ÐšÐ¾Ð¼Ð¿Ð°Ð½Ð¸Ñ (Ð‘Ð˜Ð): ${bin}
- Ð—Ð°Ð¿Ñ€Ð°ÑˆÐ¸Ð²Ð°ÐµÐ¼Ð°Ñ ÑÑƒÐ¼Ð¼Ð°: ${amount}
- Ð¡Ñ€Ð¾Ðº: ${termMonths}
- Ð¦ÐµÐ»ÑŒ Ñ„Ð¸Ð½Ð°Ð½ÑÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ: ${purpose}
- ÐšÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ñ‹: ${contacts}

Ð—ÐÐ”ÐÐ§Ð:
ÐŸÑ€Ð¾Ð°Ð½Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐ¹ Ð²ÑÐµ ${allFiles.length} Ð±Ð°Ð½ÐºÐ¾Ð²ÑÐºÐ¸Ðµ Ð²Ñ‹Ð¿Ð¸ÑÐºÐ¸ (Ñ„Ð°Ð¹Ð»Ñ‹ ÑƒÐ¶Ðµ Ð¿Ñ€Ð¸ÐºÑ€ÐµÐ¿Ð»ÐµÐ½Ñ‹) Ð¸ ÑÐ¾Ð·Ð´Ð°Ð¹ Ð¿Ð¾Ð»Ð½Ñ‹Ð¹ Ñ„Ð¸Ð½Ð°Ð½ÑÐ¾Ð²Ñ‹Ð¹ Ð¾Ñ‚Ñ‡ÐµÑ‚ Ð¿Ð¾ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ðµ Ð¸Ð· Ñ‚Ð²Ð¾Ð¸Ñ… Ð¸Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ð¹.`
            
            console.log(`ðŸ“ Ð—Ð°Ð¿Ñ€Ð¾Ñ Ðº Ð°Ð³ÐµÐ½Ñ‚Ñƒ:`)
            console.log(reportRequest)
            console.log(`\nâ±ï¸ Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Financial Analyst Agent...`)
            
            const reportRunner = new Runner({})
            const startAnalysis = Date.now()
            
            // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ñ‚Ð°Ð¹Ð¼Ð°ÑƒÑ‚ Ð½Ð° 300 ÑÐµÐºÑƒÐ½Ð´ (5 Ð¼Ð¸Ð½ÑƒÑ‚) Ð´Ð»Ñ Ð°Ð½Ð°Ð»Ð¸Ð·Ð° Ð²ÑÐµÑ… Ñ„Ð°Ð¹Ð»Ð¾Ð²
            const analysisTimeout = new Promise((_, reject) =>
              setTimeout(() => reject(new Error('Financial Analyst timeout (300s)')), 300000)
            )
            
            const reportResult = await Promise.race([
              reportRunner.run(analystWithFiles, [
                { role: 'user', content: reportRequest }
              ]),
              analysisTimeout
            ])
            
            const analysisTime = ((Date.now() - startAnalysis) / 1000).toFixed(2)
            console.log(`â±ï¸ ÐÐ½Ð°Ð»Ð¸Ð· Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½ Ð·Ð° ${analysisTime}s`)
            console.log(`ðŸ“¦ ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¾ ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ð¾Ð²: ${reportResult.newItems.length}`)
            
            // Ð›Ð¾Ð³Ð¸Ñ€ÑƒÐµÐ¼ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñƒ Ð¾Ñ‚Ð²ÐµÑ‚Ð° Ð´Ð»Ñ Ð¾Ñ‚Ð»Ð°Ð´ÐºÐ¸
            console.log(`ðŸ” Ð¡Ñ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° Ð¾Ñ‚Ð²ÐµÑ‚Ð°:`)
            console.log(JSON.stringify(reportResult.newItems.map((item, i) => ({
              index: i,
              role: item.rawItem?.role,
              contentType: item.rawItem?.content?.[0]?.type,
              hasText: !!item.rawItem?.content?.[0]?.text,
              textLength: item.rawItem?.content?.[0]?.text?.length || 0
            })), null, 2))
            
            // Ð˜Ð·Ð²Ð»ÐµÐºÐ°ÐµÐ¼ Ð¾Ñ‚Ñ‡ÐµÑ‚ - Ð¿Ñ€Ð¾Ð±ÑƒÐµÐ¼ Ð²ÑÐµ Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚Ñ‹
            let report = 'ÐžÑ‚Ñ‡ÐµÑ‚ Ð½Ðµ ÑÐ³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ð½'
            
            // Ð’Ð°Ñ€Ð¸Ð°Ð½Ñ‚ 1: Ð¸Ñ‰ÐµÐ¼ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ð¹ assistant message Ñ Ñ‚ÐµÐºÑÑ‚Ð¾Ð¼
            for (let i = reportResult.newItems.length - 1; i >= 0; i--) {
              const item = reportResult.newItems[i]
              if (item.rawItem?.role === 'assistant') {
                console.log(`ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚ ${i}:`, {
                  role: item.rawItem.role,
                  contentLength: item.rawItem.content?.length,
                  firstContentType: item.rawItem.content?.[0]?.type,
                  hasText: !!item.rawItem.content?.[0]?.text
                })
                
                if (item.rawItem.content?.[0]?.text) {
                  report = item.rawItem.content[0].text
                  console.log(`âœ… ÐÐ°Ð¹Ð´ÐµÐ½ Ð¾Ñ‚Ñ‡ÐµÑ‚ Ð² ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ðµ ${i}, Ð´Ð»Ð¸Ð½Ð°: ${report.length} ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð²`)
                  break
                }
              }
            }
            
            // Ð’Ð°Ñ€Ð¸Ð°Ð½Ñ‚ 2: ÐµÑÐ»Ð¸ Ð½Ðµ Ð½Ð°ÑˆÐ»Ð¸, Ð¿Ñ€Ð¾Ð±ÑƒÐµÐ¼ Ñ‡ÐµÑ€ÐµÐ· content.value
            if (report === 'ÐžÑ‚Ñ‡ÐµÑ‚ Ð½Ðµ ÑÐ³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ð½') {
              console.log(`âš ï¸ Ð’Ð°Ñ€Ð¸Ð°Ð½Ñ‚ 1 Ð½Ðµ ÑÑ€Ð°Ð±Ð¾Ñ‚Ð°Ð», Ð¿Ñ€Ð¾Ð±ÑƒÐµÐ¼ Ð°Ð»ÑŒÑ‚ÐµÑ€Ð½Ð°Ñ‚Ð¸Ð²Ð½Ñ‹Ðµ Ð¿ÑƒÑ‚Ð¸...`)
              for (let i = reportResult.newItems.length - 1; i >= 0; i--) {
                const item = reportResult.newItems[i]
                if (item.rawItem?.role === 'assistant' && item.rawItem.content) {
                  for (const content of item.rawItem.content) {
                    if (content.type === 'text' && content.text?.value) {
                      report = content.text.value
                      console.log(`âœ… ÐÐ°Ð¹Ð´ÐµÐ½ Ð¾Ñ‚Ñ‡ÐµÑ‚ Ñ‡ÐµÑ€ÐµÐ· text.value Ð² ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ðµ ${i}`)
                      break
                    }
                  }
                  if (report !== 'ÐžÑ‚Ñ‡ÐµÑ‚ Ð½Ðµ ÑÐ³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ð½') break
                }
              }
            }
            
            // Ð’Ð°Ñ€Ð¸Ð°Ð½Ñ‚ 3: ÐµÑÐ»Ð¸ Ð²ÑÐµ ÐµÑ‰Ðµ Ð½Ðµ Ð½Ð°ÑˆÐ»Ð¸, Ð²Ñ‹Ð²Ð¾Ð´Ð¸Ð¼ Ð¿Ð¾Ð»Ð½ÑƒÑŽ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñƒ Ð¿ÐµÑ€Ð²Ð¾Ð³Ð¾ assistant message
            if (report === 'ÐžÑ‚Ñ‡ÐµÑ‚ Ð½Ðµ ÑÐ³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ð½' && reportResult.newItems.length > 0) {
              console.log(`âš ï¸ Ð’Ð°Ñ€Ð¸Ð°Ð½Ñ‚ 2 Ð½Ðµ ÑÑ€Ð°Ð±Ð¾Ñ‚Ð°Ð». ÐŸÐ¾Ð»Ð½Ð°Ñ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° Ð¿ÐµÑ€Ð²Ð¾Ð³Ð¾ assistant message:`)
              const assistantItem = reportResult.newItems.find(item => item.rawItem?.role === 'assistant')
              if (assistantItem) {
                console.log(JSON.stringify(assistantItem.rawItem, null, 2))
              }
            }
            
            // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð¾Ñ‚Ñ‡ÐµÑ‚
            sessionReports.set(session, {
              report,
              generated: new Date().toISOString(),
              filesCount: allFiles.length
            })
            
            console.log(`âœ… Ð¤Ð¸Ð½Ð°Ð½ÑÐ¾Ð²Ñ‹Ð¹ Ð¾Ñ‚Ñ‡ÐµÑ‚ ÑÐ³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ð½ Ð´Ð»Ñ ÑÐµÑÑÐ¸Ð¸ ${session}`)
            console.log(`ðŸ“Š ========== ÐžÐ¢Ð§Ð•Ð¢ Ð”Ð›Ð¯ ÐœÐ•ÐÐ•Ð”Ð–Ð•Ð Ð ==========`)
            console.log(report)
            console.log(`ðŸ“Š ==========================================\n`)
            
          } catch (error) {
            console.error(`âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð°:`, error.message)
            console.error(`âŒ Ð¡Ñ‚ÐµÐº Ð¾ÑˆÐ¸Ð±ÐºÐ¸:`, error.stack)
            
            // ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð¸Ð· sessionFiles
            const allFiles = sessionFiles.get(session) || []
            
            // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð¾Ð± Ð¾ÑˆÐ¸Ð±ÐºÐµ ÐºÐ°Ðº Ð¾Ñ‚Ñ‡ÐµÑ‚
            sessionReports.set(session, {
              report: `ÐžÑˆÐ¸Ð±ÐºÐ° Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð°: ${error.message}`,
              generated: new Date().toISOString(),
              filesCount: allFiles.length,
              error: true
            })
          }
        })
      }
      
      return res.json({ 
        ok: true, 
        message: agentMessage,
        sessionId: session,
        completed: isFinalMessage  // Ð¤Ð»Ð°Ð³ Ð´Ð»Ñ Ñ„Ñ€Ð¾Ð½Ñ‚ÐµÐ½Ð´Ð°
      })
    }

    if (classification === 'get_information') {
      console.log(`â„¹ï¸ Ð—Ð°Ð¿ÑƒÑÐº Information Agent...`)
      const info = await runner.run(informationAgent, [...history])
      
      // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð¾Ñ‚Ð²ÐµÑ‚ Ð² Ð¸ÑÑ‚Ð¾Ñ€Ð¸ÑŽ
      history.push(...info.newItems.map(item => item.rawItem))
      
      let infoMessage = 'Ð“Ð¾Ñ‚Ð¾Ð²Ð¾'
      for (let i = info.newItems.length - 1; i >= 0; i--) {
        const item = info.newItems[i]
        if (item.rawItem?.role === 'assistant' && item.rawItem?.content?.[0]?.text) {
          infoMessage = item.rawItem.content[0].text
          break
        }
      }
      
      console.log(`ðŸ’¬ ÐžÑ‚Ð²ÐµÑ‚ Information Agent: "${infoMessage}"`)
      return res.json({ ok: true, message: infoMessage, sessionId: session })
    }

    // Ð”Ð»Ñ Ð´Ñ€ÑƒÐ³Ð¸Ñ… ÐºÐ»Ð°ÑÑÐ¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ð¹ - ÐµÑÐ»Ð¸ Ñƒ Ð½Ð°Ñ ÑƒÐ¶Ðµ ÐµÑÑ‚ÑŒ Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ñ, ÑÐºÐ¾Ñ€ÐµÐµ Ð²ÑÐµÐ³Ð¾ ÑÑ‚Ð¾ Ñ‡Ð°ÑÑ‚ÑŒ Ð´Ð¸Ð°Ð»Ð¾Ð³Ð°
    if (history.length > 1) {
      console.log(`â“ ÐšÐ»Ð°ÑÑÐ¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ñ "${classification}", Ð½Ð¾ ÐµÑÑ‚ÑŒ Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ñ - Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ð² Investment Agent`)
      
      const startTime = Date.now()
      console.log(`â±ï¸ ÐÐ°Ñ‡Ð°Ð»Ð¾ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ Ð°Ð³ÐµÐ½Ñ‚Ð°: ${new Date().toLocaleTimeString()}`)
      
      const inv = await runner.run(investmentAgent, [...history])
      
      const duration = ((Date.now() - startTime) / 1000).toFixed(2)
      console.log(`â±ï¸ ÐÐ³ÐµÐ½Ñ‚ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½ Ð·Ð° ${duration}s`)
      console.log(`ðŸ¤– ÐÐ³ÐµÐ½Ñ‚ Ð²ÐµÑ€Ð½ÑƒÐ»: ${inv.newItems.length} Ð½Ð¾Ð²Ñ‹Ñ… ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ð¾Ð²`)
      
      let agentMessage = 'ÐŸÑ€Ð¾Ð´Ð¾Ð»Ð¶Ð°ÐµÐ¼ ÑÐ±Ð¾Ñ€ Ð´Ð°Ð½Ð½Ñ‹Ñ…'
      for (let i = inv.newItems.length - 1; i >= 0; i--) {
        const item = inv.newItems[i]
        if (item.rawItem?.role === 'assistant' && item.rawItem?.content?.[0]?.text) {
          agentMessage = item.rawItem.content[0].text
          break
        }
      }
      
      console.log(`ðŸ’¬ ÐžÑ‚Ð²ÐµÑ‚ Ð°Ð³ÐµÐ½Ñ‚Ð°: "${agentMessage}"`)
      
      if (agentMessage.includes('=== Ð¤Ð˜ÐÐÐÐ¡ÐžÐ’Ð«Ð™ ÐÐÐÐ›Ð˜Ð— ===') || 
          agentMessage.includes('=== Ð˜Ð¢ÐžÐ“ÐžÐ’Ð«Ð™ ÐžÐ¢Ð§Ð•Ð¢ ÐŸÐž Ð—ÐÐ¯Ð’ÐšÐ• ===')) {
        console.log(`\nðŸ“Š ========== ÐžÐ¢Ð§Ð•Ð¢ Ð”Ð›Ð¯ ÐœÐ•ÐÐ•Ð”Ð–Ð•Ð Ð ==========`)
        console.log(agentMessage)
        console.log(`ðŸ“Š ==========================================\n`)
      }
      
      history.push(...inv.newItems.map(item => item.rawItem))
      console.log(`ðŸ’¾ Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð°: ${history.length} ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹`)
      
      return res.json({ ok: true, message: agentMessage, sessionId: session })
    }

    console.log(`â“ ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð°Ñ ÐºÐ»Ð°ÑÑÐ¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ñ: ${classification}`)
    return res.json({ ok: true, message: 'ÐÐµ Ð¿Ð¾Ð½ÑÐ» Ð·Ð°Ð¿Ñ€Ð¾Ñ', sessionId: session })
  } catch (e) {
    console.error('agents error', e)
    return res.status(500).json({ ok: false, error: String(e) })
  }
})

// Ð­Ð½Ð´Ð¿Ð¾Ð¸Ð½Ñ‚ Ð´Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ñ„Ð¸Ð½Ð°Ð½ÑÐ¾Ð²Ð¾Ð³Ð¾ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð°
app.get('/api/agents/report/:sessionId', (req, res) => {
  const { sessionId } = req.params
  
  console.log(`ðŸ“Š Ð—Ð°Ð¿Ñ€Ð¾Ñ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð° Ð´Ð»Ñ ÑÐµÑÑÐ¸Ð¸: ${sessionId}`)
  
  const reportData = sessionReports.get(sessionId)
  
  if (!reportData) {
    console.log(`âš ï¸ ÐžÑ‚Ñ‡ÐµÑ‚ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ Ð´Ð»Ñ ÑÐµÑÑÐ¸Ð¸ ${sessionId}`)
    return res.json({
      ok: false,
      message: 'ÐžÑ‚Ñ‡ÐµÑ‚ ÐµÑ‰Ðµ Ð½Ðµ ÑÐ³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ð½. ÐŸÐ¾Ð´Ð¾Ð¶Ð´Ð¸Ñ‚Ðµ Ð½ÐµÑÐºÐ¾Ð»ÑŒÐºÐ¾ ÑÐµÐºÑƒÐ½Ð´.'
    })
  }
  
  console.log(`âœ… ÐžÑ‚Ñ‡ÐµÑ‚ Ð½Ð°Ð¹Ð´ÐµÐ½, Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ñƒ`)
  return res.json({
    ok: true,
    report: reportData.report,
    generated: reportData.generated,
    filesCount: reportData.filesCount
  })
})

const PORT = process.env.PORT || 8787
app.listen(PORT, () => {
  console.log(`[server] agents listening on ${PORT}`)
  console.log(`[server] API key present: ${!!process.env.OPENAI_API_KEY}`)
})

// Keep server alive
process.on('SIGTERM', () => {
  console.log('[server] SIGTERM received, shutting down gracefully')
  process.exit(0)
})

process.on('SIGINT', () => {
  console.log('[server] SIGINT received, shutting down gracefully')
  process.exit(0)
})


