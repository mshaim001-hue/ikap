'use strict'

const { McpServer } = require('@modelcontextprotocol/sdk/server/mcp.js')
const { StdioServerTransport } = require('@modelcontextprotocol/sdk/server/stdio.js')
const { z } = require('zod')

const server = new McpServer({
  name: 'ikapitalist-info',
  version: '1.0.0'
})

/** @type {Record<string, string>} */
const sections = {
  overview: [
    '# Обзор iKapitalist',
    '',
    'iKapitalist — лицензированная инвестиционная и заёмная краудфандинговая платформа, работающая с 2019 года.',
    'Платформа помогает малому и среднему бизнесу привлекать финансирование от инвесторов на прозрачных условиях.',
    'Инвесторы могут выдавать займы или покупать доли в компаниях, получая доходность от 24% годовых.',
    '',
    '**Ключевые факты:**',
    '- Запуск: 2019 год',
    '- Лицензия AFSA-А-LA-2023-0005 (Астана, МФЦА)',
    '- Управление инвестиционной и заёмной краудфандинговой платформой',
    '- Возможность прямого общения инвесторов с собственниками бизнеса'
  ].join('\n'),
  licensing: [
    '# Лицензирование и регулирование',
    '',
    'Платформа iKapitalist.kz зарегистрирована в юрисдикции Международного финансового центра «Астана» (МФЦА) и регулируется Управлением по финансовым услугам AFSA.',
    '',
    '**Лицензия:**',
    '- Номер: AFSA-A-LA-2023-0005',
    '- Дата выдачи: 27.04.2023',
    '- Статус: активна',
    '- Деятельность: управление инвестиционной и заёмной краудфандинговой платформой и платформой заемного финансирования'
  ].join('\n'),
  products: [
    '# Инвестиционные продукты',
    '',
    'Платформа предлагает несколько форматов финансирования для инвесторов и компаний-заёмщиков:',
    '',
    '- **Займы:** фиксированная ставка от 30% годовых, срок 4–36 месяцев, сумма от 10 млн до 1 млрд ₸',
    '- **Облигации:** инструмент привлечения долгового капитала',
    '- **Доли бизнеса:** участие в капитале растущих компаний',
    '',
    'Все сделки оформляются в соответствии с нормами AFSA, платформа собирает личные гарантии и поручительства предпринимателей.'
  ].join('\n'),
  operations: [
    '# Как работает платформа',
    '',
    '1. iKapitalist отбирает предложения компаний-заёмщиков, проводит проверку налоговой и финансовой отчётности, кредитного отчёта и учредительных документов.',
    '2. После проверки инвестиционное предложение публикуется на платформе (AFSA не проверяет данные компаний).',
    '3. Инвесторы самостоятельно принимают решение о вложениях, опираясь на опубликованную информацию.',
    '4. После сбора полной суммы инвестиций запускается 48-часовой период заморозки, когда инвесторы могут бесплатно отменить заявки.',
    '5. По завершении заморозки iKapitalist подготавливает и организует подписание договоров, собирает средства и перечисляет их компании.',
    '6. На протяжении всего срока займа платформа администрирует платежи, следит за выполнением обязательств и взаимодействует со сторонами.',
    '7. Комиссии платформы: с компаний — за привлечение финансирования, с инвесторов — по завершении договоров займа.'
  ].join('\n'),
  default_management: [
    '# Действия при просрочках и дефолте',
    '',
    'Если заемщик просрочил оплату, платформа контактирует его, выясняет причины и начисляет неустойку.',
    'При просрочке свыше 60 дней статус сделки меняется на «дефолт». Платформа инициирует переуступку прав требования задолженности и начинает процедуру взыскания от имени всех инвесторов.',
    'Инвестор может отказаться от переуступки и заниматься взысканием самостоятельно — платформа предоставит все необходимые документы и данные по сделке.'
  ].join('\n'),
  legal_framework: [
    '# Правовое регулирование договоров',
    '',
    'Все договоры займа между инвестором и заемщиком регулируются законодательством Международного Финансового Центра Астана, действующего в соответствии с конституционным законом «О МФЦА».'
  ].join('\n'),
  material_changes: [
    '# Порядок действий при изменениях условий займа',
    '',
    'Платформа уведомляет инвесторов о значимых изменениях в обстоятельствах заемщика через личный кабинет и, при необходимости, организует онлайн-звонки.',
    'Если изменения выявлены до подписания договоров, проводится голосование: решение продолжается при согласии инвесторов на сумму ≥90% финансирования, иначе сделка возвращается на этап привлечения.',
    'Если существенные изменения выявлены на стадии исполнения договоров, платформа вправе с согласия инвесторов объявить дефолт и потребовать досрочного возврата займа.'
  ].join('\n'),
  aml: [
    '# Процедуры AML/CFT',
    '',
    'Все компании и инвесторы проходят проверку по требованиям противодействия отмыванию денег и финансированию терроризма (AML/CFT).',
    'Процедура охватывает более 60 параметров, включая аресты, налоговые задолженности, текущие судебные разбирательства.',
    'Подозрительные транзакции передаются в уполномоченный государственный орган финансового мониторинга Республики Казахстан.'
  ].join('\n'),
  contingency: [
    '# План непрерывности бизнеса',
    '',
    'На случай сбоев или прекращения деятельности iKapitalist предусмотрены меры:',
    '- резервные серверы для сохранности данных;',
    '- коммуникационный план для оперативного уведомления инвесторов;',
    '- соблюдение обязательных нормативных требований и отчетности;',
    '- предоставление инвесторам прямого доступа к контактам заемщиков, графикам платежей и инструкциям для самостоятельного взыскания при необходимости;',
    '- выполнение текущих обязательств перед инвесторами по мере возможностей даже при прекращении работы.'
  ].join('\n'),
  contacts: [
    '# Контакты iKapitalist',
    '',
    'Адрес: Мангилик Ел, 55/21, блок С4.2, офис 265, Астана, Казахстан',
    'Телефон: +7 700 178 00 18',
    'Электронная почта: claims@ikapitalist.kz',
    '',
    'Регулятор AFSA:',
    '- Адрес: ул. Мангилик Ел 55/17, блок C3.2, Астана, Казахстан',
    '- Телефон: +7 (7172) 64 73 71',
    '- Email: apd@afsa.kz'
  ].join('\n'),
  complaints: [
    '# Политика обработки жалоб',
    '',
    'Жалоба — выраженное недовольство услугами, продуктами, сотрудниками или процессом рассмотрения жалоб, когда ожидается ответ.',
    '',
    '**Основные принципы:**',
    '- Платформа поощряет получение обратной связи и обеспечивает своевременное рассмотрение жалоб.',
    '- Жалобы не принимаются анонимно.',
    '- Предоставляются понятные процедуры, несколько каналов подачи и уважительное отношение к заявителям.',
    '- Платформа защищает заявителей от негативных последствий за факт подачи жалобы.',
    '- Возможна помощь представителя заявителя по его желанию.',
    '',
    '**Процесс рассмотрения:**',
    '1. Регистрация жалобы и присвоение уникального идентификатора.',
    '2. Подтверждение получения жалобы в течение 3 рабочих дней.',
    '3. Оценка срочности и серьезности, определение необходимости дополнительного участия других организаций.',
    '4. Рассмотрение, сбор дополнительных данных и информирование заявителя о ходе и результатах.',
    '5. Предоставление оснований решения, возможных компенсаций и вариантов пересмотра.',
    '6. Ведение учета, отчетность, мониторинг выполнения принятых мер.',
    '',
    'Для соответствия правилам AFSA на сайте и в офисах публикуются контакты для жалоб и указание на возможность обращения напрямую в AFSA.'
  ].join('\n'),
  risks: [
    '# Основные риски инвесторов',
    '',
    '- **Риск потери средств:** заемщики могут не выполнить обязательства, особенно в сегменте МСБ.',
    '- **Риск по акциям:** отсутствует гарантия дивидендов, возможна допэмиссия и размытие доли; при частично оплаченных акциях инвестор обязан внести оставшиеся суммы.',
    '- **Высокий риск сектора МСБ:** вероятность неудачи бизнеса выше средней.',
    '- **Ликвидность:** продажа доли или займа может быть сложной, вторичный рынок не гарантирует быструю сделку.',
    '- **Закрытие платформы:** возможны задержки и расходы при прекращении работы платформы.',
    '- **Иностранные компании:** регулирование другой юрисдикцией, дополнительные налоги, комиссии, валютный контроль.',
    '- **Ограничения раскрытия:** эмитенты не обязаны предоставлять полный пакет данных, возможен дефицит информации.',
    '- **Неточность отчетности:** финансовая отчетность может быть неаудированной и содержать ошибки.',
    '- **Недостаточная диверсификация:** концентрация вложений в одной сделке повышает вероятность значительных потерь.'
  ].join('\n')
}

const sectionIds = Object.keys(sections)

sectionIds.forEach((sectionId) => {
  const text = sections[sectionId]
  server.registerResource(
    `ikapitalist-${sectionId}`,
    `ikapitalist://${sectionId}`,
    {
      title: `iKapitalist · ${sectionId.replace(/_/g, ' ')}`,
      description: `Информация о разделе "${sectionId}" платформы iKapitalist`,
      mimeType: 'text/markdown'
    },
    async (uri) => ({
      contents: [
        {
          uri: uri.href,
          text,
          mimeType: 'text/markdown'
        }
      ]
    })
  )
})

server.registerTool(
  'ikapitalist_get_section',
  {
    title: 'Получить раздел справки iKapitalist',
    description: 'Возвращает структурированный текст по ключевому разделу справки платформы iKapitalist.',
    inputSchema: {
      section: z.enum(sectionIds)
    },
    outputSchema: {
      section: z.string(),
      text: z.string()
    }
  },
  async ({ section }) => {
    const key = section || 'overview'
    const text = sections[key]
    if (!text) {
      return {
        content: [
          {
            type: 'text',
            text: `Раздел "${section}" не найден. Доступные разделы: ${sectionIds.join(', ')}.`
          }
        ],
        isError: true
      }
    }

    const payload = {
      section: key,
      text
    }

    return {
      content: [
        {
          type: 'text',
          text
        }
      ],
      structuredContent: payload
    }
  }
)

const transport = new StdioServerTransport()

server.connect(transport).catch((error) => {
  console.error('[ikapitalist-info-mcp] Не удалось запустить MCP сервер:', error)
  process.exit(1)
})

process.on('SIGINT', async () => {
  await transport.close?.()
  process.exit(0)
})

process.on('SIGTERM', async () => {
  await transport.close?.()
  process.exit(0)
})


